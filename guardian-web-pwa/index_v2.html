<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <title>EduFocus Respons√°veis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #fafafa;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        .container {
            max-width: 440px;
            margin: 0 auto;
            background: white;
        }

        /* Header */
        .header {
            background: #6366f1;
            padding: 16px 20px;
            color: white;
        }

        .header-greeting {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .header-subtitle {
            font-size: 13px;
            opacity: 0.85;
        }

        /* Content */
        .content {
            padding: 16px;
        }

        /* Child Card */
        .child-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .child-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #6366f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .child-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .child-info {
            flex: 1;
        }

        .child-name {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
        }

        .child-details {
            font-size: 12px;
            color: #6b7280;
        }

        /* Add Button */
        .add-btn {
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 8px 0 12px;
            max-width: 440px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 4px 12px;
            color: #9ca3af;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: #6366f1;
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
        }

        /* Empty State */
        .empty {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.2;
        }

        .empty-title {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .empty-text {
            font-size: 13px;
            color: #6b7280;
        }

        /* Login/Register */
        .auth-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #6366f1;
        }

        .auth-header {
            padding: 40px 20px 24px;
            text-align: center;
            color: white;
        }

        .auth-logo {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .auth-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }

        .auth-content {
            flex: 1;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 24px 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .input {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
        }

        .input:focus {
            outline: none;
            border-color: #6366f1;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: #6366f1;
            color: white;
            cursor: pointer;
        }

        .link {
            text-align: center;
            margin-top: 16px;
            font-size: 13px;
            color: #6b7280;
        }

        .link a {
            color: #6366f1;
            text-decoration: none;
            font-weight: 600;
        }

        .alert {
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .hidden {
            display: none !important;
        }

        /* Link Flow */
        .steps {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
        }

        .step {
            flex: 1;
            height: 3px;
            background: #e5e7eb;
            border-radius: 2px;
        }

        .step.active {
            background: #6366f1;
        }

        .result-item {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .result-item.selected {
            background: #ede9fe;
            border-color: #6366f1;
        }

        .preview {
            text-align: center;
            padding: 24px;
            background: #f9fafb;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .preview-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 12px;
            background: #6366f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            font-weight: 600;
        }

        .preview-photo img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .preview-name {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .preview-details {
            font-size: 13px;
            color: #6b7280;
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: #f3f4f6;
            color: #374151;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 11px;
            color: #6b7280;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
        }

        /* Chat Styles */
        .chat-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            background: white;
            transition: background 0.2s;
        }

        .chat-list-item:active {
            background: #f9fafb;
        }

        .chat-screen-content {
            background: #e5ddd5;
            min-height: 100vh;
            padding-bottom: 70px;
            /* Space for input bar */
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .chat-bubble.sent {
            background: #dcf8c6;
            align-self: flex-end;
            margin-left: auto;
            border-top-right-radius: 0;
        }

        .chat-bubble.received {
            background: white;
            align-self: flex-start;
            margin-right: auto;
            border-top-left-radius: 0;
        }

        .chat-time {
            font-size: 10px;
            color: #999;
            text-align: right;
            margin-top: 4px;
        }

        /* Cards de Eventos */
        .event-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .event-title {
            font-weight: 700;
            font-size: 16px;
            color: #111827;
            margin: 0;
        }

        .badge-cost {
            background: #ecfdf5;
            color: #059669;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .event-desc {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .event-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .event-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .event-footer {
            border-top: 1px solid #f3f4f6;
            padding-top: 8px;
            font-size: 12px;
            color: #9ca3af;
        }

        .pix-box {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 10px;
            margin-top: 12px;
            font-size: 13px;
            color: #92400e;
        }

        /* ... outros estilos ... */
        .chat-input-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 440px;
            background: #f0f2f5;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-top: 1px solid #ddd;
            z-index: 1000;
        }

        .chat-input {
            flex: 1;
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            background: #fff;
            font-family: inherit;
            outline: none;
            height: 40px;
            /* Consistent height */
        }

        .chat-input:focus {
            outline: none;
        }

        .chat-btn-icon {
            background: none;
            border: none;
            font-size: 24px;
            color: #54656f;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        /* Specific styles for Mic and Send buttons (Green Circle) */
        #micBtn,
        #sendBtn {
            background: #00a884;
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            min-width: 45px;
            padding: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            font-size: 20px;
        }

        #sendBtn {
            /* Keep original color override or use green? WhatsApp uses green circle for send/mic */
            /* Previous code had style="color: #6366f1" inline. I should override this carefully or effectively */
            color: white !important;
            /* Force white icon on green bg */
        }

        .chat-img-preview {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .chat-audio {
            width: 200px;
        }

        /* Hide bottom nav when in chat */
        .hidden-nav .bottom-nav {
            display: none !important;
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 20px;
        }

        .calendar-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border-radius: 8px;
            position: relative;
        }

        .day-present {
            background: #d1fae5;
            color: #065f46;
            font-weight: 600;
        }

        .day-absent {
            background: #fee2e2;
            color: #991b1b;
            font-weight: 600;
        }

        .day-empty {
            background: transparent;
        }

        .day-today {
            border: 2px solid #6366f1;
        }



        .event-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .event-title {
            font-weight: 600;
            font-size: 16px;
            color: #111827;
        }

        .event-date {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .event-desc {
            font-size: 14px;
            color: #4b5563;
            margin-bottom: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .event-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #f3f4f6;
            padding-top: 12px;
        }

        .event-school {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .event-cost {
            font-weight: 600;
            color: #059669;
            font-size: 14px;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 18px;
            padding: 8px;
            cursor: pointer;
            color: #6366f1;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="auth-container">
                <div class="auth-header">
                    <div class="auth-logo">üì±</div>
                    <h1 class="auth-title">EduFocus</h1>
                    <p class="auth-subtitle">Acompanhe seu filho</p>
                </div>
                <div class="auth-content">
                    <div id="loginError" class="alert alert-error hidden"></div>
                    <div class="form-group">
                        <label class="label">Email</label>
                        <input type="email" id="loginEmail" class="input" placeholder="seu@email.com">
                    </div>
                    <div class="form-group">
                        <label class="label">Senha</label>
                        <input type="password" id="loginPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn-primary" onclick="login()">Entrar</button>
                    <div class="link">
                        N√£o tem conta? <a href="#" onclick="showRegister()">Cadastre-se</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="hidden">
            <div class="auth-container">
                <div class="auth-header">
                    <div class="auth-logo">‚ú®</div>
                    <h1 class="auth-title">Criar Conta</h1>
                    <p class="auth-subtitle">Preencha seus dados</p>
                </div>
                <div class="auth-content">
                    <div id="registerError" class="alert alert-error hidden"></div>
                    <div id="registerSuccess" class="alert alert-success hidden"></div>
                    <div class="form-group">
                        <label class="label">Nome Completo</label>
                        <input type="text" id="regName" class="input" placeholder="Jo√£o Silva">
                    </div>
                    <div class="form-group">
                        <label class="label">Email</label>
                        <input type="email" id="regEmail" class="input" placeholder="seu@email.com">
                    </div>
                    <div class="form-group">
                        <label class="label">Telefone</label>
                        <input type="tel" id="regPhone" class="input" placeholder="(11) 99999-9999">
                    </div>
                    <div class="form-group">
                        <label class="label">Senha</label>
                        <input type="password" id="regPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn-primary" onclick="register()">Criar Conta</button>
                    <div class="link">
                        <a href="#" onclick="showLogin()">‚Üê Voltar</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="homeScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting" id="greeting">Ol√°!</h1>
                <p class="header-subtitle">Meus Filhos</p>
            </div>
            <div class="content">
                <div id="childrenList"></div>
                <button class="add-btn" onclick="navigate('link')">+ Vincular Filho</button>
            </div>
        </div>

        <!-- Link Screen -->
        <div id="linkScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Vincular Filho</h1>
                <p class="header-subtitle" id="stepTitle">Passo 1: Escola</p>
            </div>
            <div class="content">
                <div class="steps">
                    <div class="step active" id="bar1"></div>
                    <div class="step" id="bar2"></div>
                    <div class="step" id="bar3"></div>
                    <div class="step" id="bar4"></div>
                </div>

                <div id="linkError" class="alert alert-error hidden"></div>
                <div id="linkSuccess" class="alert alert-success hidden"></div>

                <div id="step1">
                    <div class="form-group">
                        <label class="label">Nome da escola</label>
                        <input type="text" id="schoolInput" class="input" placeholder="Digite o nome..."
                            oninput="searchSchools()">
                    </div>
                    <div id="schoolResults"></div>
                </div>

                <div id="step2" class="hidden">
                    <div class="form-group">
                        <label class="label">Turma</label>
                        <div id="classResults"></div>
                    </div>
                </div>

                <div id="step3" class="hidden">
                    <div class="form-group">
                        <label class="label">Nome completo do filho</label>
                        <input type="text" id="studentInput" class="input" placeholder="Digite o nome..."
                            oninput="searchStudent()">
                    </div>
                    <div id="studentResults"></div>
                </div>

                <div id="step4" class="hidden">
                    <div class="preview">
                        <div class="preview-photo" id="previewPhoto">?</div>
                        <div class="preview-name" id="previewName">-</div>
                        <div class="preview-details" id="previewDetails">-</div>
                    </div>
                    <button class="btn-primary" onclick="confirmLink()">Confirmar</button>
                </div>

                <button class="btn-secondary" onclick="navigate('home')">Voltar</button>
            </div>
        </div>

        <!-- Reports Screen -->
        <div id="reportsScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Relat√≥rios</h1>
                <p class="header-subtitle">Frequ√™ncia Escolar</p>
            </div>
            <div class="content">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="label">Selecione o Filho</label>
                    <select id="reportStudentSelect" class="input" onchange="loadStudentReport()">
                        <!-- Options populated via JS -->
                    </select>
                </div>

                <!-- Calendar Controls -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <button class="btn-icon" onclick="changeReportMonth(-1)">‚óÄ</button>
                    <div style="text-align: center;">
                        <span id="reportMonthLabel" style="font-size: 16px; font-weight: 600; display: block;">-</span>
                        <span id="reportYearLabel" style="font-size: 12px; color: #6b7280;">-</span>
                    </div>
                    <button class="btn-icon" onclick="changeReportMonth(1)">‚ñ∂</button>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    <div class="calendar-header">D</div>
                    <div class="calendar-header">S</div>
                    <div class="calendar-header">T</div>
                    <div class="calendar-header">Q</div>
                    <div class="calendar-header">Q</div>
                    <div class="calendar-header">S</div>
                    <div class="calendar-header">S</div>
                    <div id="calendarDays" style="display: contents;"></div>
                </div>

                <!-- Legend -->
                <div
                    style="display: flex; gap: 20px; justify-content: center; margin-top: 20px; padding: 15px; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                        <div style="width: 16px; height: 16px; background: #d1fae5; border-radius: 4px;"></div> Presente
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                        <div style="width: 16px; height: 16px; background: #fee2e2; border-radius: 4px;"></div> Ausente
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Screen -->
        <div id="notificationsScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Eventos</h1>
                <p class="header-subtitle">Passeios e Comunicados</p>
            </div>
            <div class="content">
                <div id="eventsList"></div>
                <div class="empty" id="eventsEmpty">
                    <div class="empty-icon">üìÖ</div>
                    <p class="empty-title">Nenhum aviso</p>
                    <p class="empty-text">A escola ainda n√£o publicou eventos.</p>
                </div>
            </div>
        </div>

        <!-- Messages Screen (List of Chats) -->
        <div id="messagesScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Mensagens</h1>
                <p class="header-subtitle">Converse com a escola</p>
            </div>
            <div class="content" style="padding: 0;">
                <div id="chatList">
                    <!-- Populated via JS -->
                </div>
                <div id="emptyChat" class="empty hidden">
                    <div class="empty-icon">üí¨</div>
                    <p class="empty-title">Nenhuma mensagem</p>
                </div>
            </div>
        </div>

        <!-- Chat Detail Screen -->
        <div id="chatScreen" class="hidden">
            <div class="header"
                style="position: sticky; top: 0; z-index: 100; display: flex; align-items: center; gap: 10px;">
                <button class="chat-btn-icon" style="color: white; font-size: 20px;" onclick="closeChat()">‚Üê</button>
                <div style="flex: 1;">
                    <h1 class="header-greeting" id="chatStudentName" style="font-size: 16px;">Aluno</h1>
                    <p class="header-subtitle" id="chatSchoolName">Escola</p>
                </div>
            </div>
            <div class="chat-screen-content">
                <div id="chatMessages" class="chat-messages">
                    <!-- Messages go here -->
                </div>
            </div>
            <div class="chat-input-bar">
                <button class="chat-btn-icon" onclick="document.getElementById('fileInput').click()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="#54656f">
                        <path
                            d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" />
                    </svg>
                </button>
                <input type="text" class="chat-input" id="messageInput" placeholder="Mensagem">
                <button class="chat-btn-icon" id="micBtn" onmousedown="startRecording()" onmouseup="stopRecording()"
                    ontouchstart="startRecording()" ontouchend="stopRecording()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                        <path
                            d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                    </svg>
                </button>
                <button class="chat-btn-icon" id="sendBtn" style="display: none;" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>

                <input type="file" id="fileInput" hidden onchange="handleFileSelect(this)">
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Configura√ß√µes</h1>
                <p class="header-subtitle">Sua conta</p>
            </div>
            <div class="content">
                <div class="section-title">Dados da Conta</div>
                <div class="form-group">
                    <label class="label">Nome</label>
                    <input type="text" id="settingsName" class="input">
                </div>
                <div class="form-group">
                    <label class="label">Email</label>
                    <input type="email" id="settingsEmail" class="input" disabled>
                </div>
                <div class="form-group">
                    <label class="label">Telefone</label>
                    <input type="tel" id="settingsPhone" class="input">
                </div>
                <button class="btn-primary">Salvar</button>
                <button class="btn-secondary" onclick="logout()">Sair</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav hidden" id="bottomNav">
            <div class="nav-item active" onclick="navigate('home')">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">In√≠cio</div>
            </div>
            <div class="nav-item" onclick="navigate('reports')">
                <div class="nav-icon">üìä</div>
                <div class="nav-label" style="line-height:1.1; font-size:10px;">Frequ√™ncia<br>Escolar</div>
            </div>
            <div class="nav-item" onclick="navigate('notifications')">
                <div class="nav-icon">üìÖ</div>
                <div class="nav-label">Eventos</div>
            </div>
            <div class="nav-item" onclick="navigate('messages')">
                <div class="nav-icon">üí¨</div>
                <div class="nav-label">Mensagens</div>
            </div>
            <div class="nav-item" onclick="navigate('settings')">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Conta</div>
            </div>
        </div>
        <script>
            // Desbloquear AudioContext com intera√ß√£o do usu√°rio (obrigat√≥rio em navegadores modernos)
            window.audioCtxGlobal = null;
            document.addEventListener('click', () => {
                if (!window.audioCtxGlobal) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    window.audioCtxGlobal = new AudioContext();
                }
                if (window.audioCtxGlobal.state === 'suspended') {
                    window.audioCtxGlobal.resume();
                }
            }, { once: false }); // Tenta desbloquear em qualquer clique
        </script>
    </div>

    <script>
        // API Local (Porta 5000)
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:5000/api'
            : `http://${window.location.hostname}:5000/api`;

        let user = null;
        let selectedSchool = null;
        let selectedClass = null;
        let selectedStudent = null;
        let eventSource = null;
        let myStudentsData = [];
        let currentReportDate = new Date();
        let activeChatStudentId = null;
        let chatPollInterval = null;
        let mediaRecorder = null;
        let audioChunks = [];

        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');

            if (token && userData) {
                try {
                    user = JSON.parse(userData);
                    navigate('home');
                    startNotificationPoller();
                } catch (e) {
                    showLogin();
                }
            } else {
                showLogin();
            }
        });

        // --- REAL-TIME: SERVER SENT EVENTS (Webhook Listening) ---
        function startNotificationListener() {
            if (eventSource && (eventSource.readyState === 0 || eventSource.readyState === 1)) return; // J√° conectado ou conectando

            const token = localStorage.getItem('token');
            if (!token) return;

            // Conectar ao endpoint SSE unificado
            const sseUrl = `${API_URL}/guardian/events?token=${token}`;
            console.log('üì° Conectando ao canal de notifica√ß√µes (SSE)...', sseUrl);

            eventSource = new EventSource(sseUrl);

            eventSource.onopen = () => console.log('‚úÖ Canal de Notifica√ß√µes Ativo (SSE)');

            eventSource.onmessage = (event) => {
                try {
                    // Ignorar heartbeat ou mensagens de controle se houver
                    if (!event.data || event.data.includes('"type":"connected"')) return;

                    const payload = JSON.parse(event.data);

                    if (payload.type === 'notification') {
                        console.log('üîî Notifica√ß√£o Recebida (SSE):', payload.data);
                        showNotificationOverlay(payload.data);
                        markAsRead(payload.data.id);
                    }
                } catch (e) {
                    // console.error('Erro ao processar evento SSE:', e);
                }
            };

            eventSource.onerror = (err) => {
                // console.log('‚ö†Ô∏è Conex√£o SSE inst√°vel...');
            };
        }

        function stopNotificationListener() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        // --- SISTEMA DE NOTIFICA√á√ÉO (POLLING - COMO ERA ANTES) ---
        let notificationPoller = null;

        function startNotificationPoller() {
            if (notificationPoller) return;
            console.log('üì° Iniciando Polling (2s)...');
            checkNotifications();
            notificationPoller = setInterval(checkNotifications, 2000);
        }

        function stopNotificationPoller() {
            if (notificationPoller) {
                clearInterval(notificationPoller);
                notificationPoller = null;
            }
        }

        let isFetching = false;
        async function checkNotifications() {
            if (isFetching) return;
            isFetching = true;

            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const res = await fetch(`${API_URL}/guardian/check-notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Se token inv√°lido, for√ßar re-login
                if (res.status === 401 || res.status === 403) {
                    console.log('üîí Token inv√°lido detectado, for√ßando re-login...');
                    stopNotificationPoller();
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    user = null;
                    showLogin();
                    return;
                }

                if (!res.ok) return;

                const data = await res.json();
                // O servidor retorna { notification } com uma √∫nica notifica√ß√£o se houver
                if (data.notification) {
                    showNotificationOverlay(data.notification);
                }
            } catch (error) {
                // Silencioso
            } finally {
                isFetching = false;
            }
        }


        let isCooldown = false; // Cooldown global para evitar spam sonoro

        function showNotificationOverlay(notif) {
            // Se estiver em cooldown, ignora
            if (isCooldown) {
                console.log('üîá Em cooldown de √°udio (10s), ignorando visualiza√ß√£o.');
                return;
            }

            // Remover overlay anterior se existir
            const existingOverlay = document.getElementById('notification-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }

            // Tela preta fullscreen
            const overlay = document.createElement('div');
            overlay.id = 'notification-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #000;
                z-index: 99999;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-between;
                padding: 4vh 5vw;
                box-sizing: border-box;
                font-family: 'Inter', sans-serif;
                overflow: hidden;
            `;

            const icon = notif.event_type === 'arrival' ? 'üëã' : 'üè†';
            const title = notif.event_type === 'arrival' ? 'CHEGOU NA ESCOLA' : 'SAIU DA ESCOLA';
            const color = notif.event_type === 'arrival' ? '#10b981' : '#f59e0b';
            const shadowRGB = notif.event_type === 'arrival' ? '16, 185, 129' : '245, 158, 11';
            const time = new Date(notif.timestamp).toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            const photoUrl = notif.photo_url || '';

            const duration = 10; // 10 Segundos

            overlay.innerHTML = `
                <!-- ESCOLA NO TOPO -->
                <div style="text-align: center; width: 100%; z-index: 10;">
                    <div style="font-size: 1.5vh; color: #888; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 1vh; font-weight: 300;">NOTIFICA√á√ÉO DE</div>
                    <h1 style="font-size: 3.5vh; font-weight: 900; color: white; margin: 0; text-transform: uppercase; line-height: 1.1; word-wrap: break-word; letter-spacing: 1px;">${notif.school_name || 'ESCOLA'}</h1>
                </div>

                <!-- FOTO CENTRAL COM EFEITO DE PULSO/GLOW -->
                <div style="
                    position: relative; 
                    width: 40vh; 
                    height: 40vh; 
                    max-width: 80vw; 
                    max-height: 80vw; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    margin: 4vh 0;
                ">
                    <!-- Camada de Anima√ß√£o de Pulso (Emanando) -->
                    <div style="
                        position: absolute;
                        top: 0; left: 0; right: 0; bottom: 0;
                        border-radius: 50%;
                        background: ${color};
                        z-index: 0;
                        animation: pulse-ring 3s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
                    "></div>
                    
                    <!-- Segunda Camada (Delay) -->
                    <div style="
                        position: absolute;
                        top: 0; left: 0; right: 0; bottom: 0;
                        border-radius: 50%;
                        background: ${color};
                        z-index: 0;
                        animation: pulse-ring 3s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
                        animation-delay: 1.5s;
                    "></div>

                    <!-- Foto do Aluno -->
                    <div style="
                        width: 100%;
                        height: 100%;
                        border-radius: 50%;
                        background: #1a1a1a;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10vh;
                        color: white;
                        font-weight: 700;
                        overflow: hidden;
                        position: relative;
                        z-index: 2;
                        border: 4px solid ${color};
                        animation: border-flash 1.5s infinite;
                    ">
                        ${photoUrl ? `<img src="${photoUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : notif.student_name.charAt(0).toUpperCase()}
                    </div>

                    <!-- √çcone de Status -->
                    <div style="
                        position: absolute;
                        bottom: 0;
                        right: 0;
                        width: 22%;
                        height: 22%;
                        background: ${color};
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 3.5vh;
                        z-index: 3;
                        border: 4px solid #000;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        animation: bounce 2s infinite;
                    ">
                        ${icon}
                    </div>
                </div>

                <!-- INFO INFERIOR -->
                <div style="text-align: center; width: 90%; z-index: 10;">
                    <h2 style="font-size: 4vh; font-weight: 800; color: white; margin: 0 0 1vh 0; text-transform: uppercase; line-height: 1.1; letter-spacing: 0.5px;">${notif.student_name}</h2>
                    
                    <!-- TURMA ADICIONADA -->
                    <div style="font-size: 2.5vh; color: rgba(255,255,255,0.7); margin-bottom: 2vh; font-weight: 500; text-transform: uppercase; letter-spacing: 1px;">
                       ${notif.className || notif.class_name || ''}
                    </div>

                    <div style="display: inline-flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); padding: 1.5vh 6vw; border-radius: 50px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); width: auto; max-width: 90%;">
                        <span style="font-size: 2vh; color: ${color}; font-weight: 700; text-transform: uppercase; margin-right: 15px; white-space: nowrap; letter-spacing: 1px;">${title}</span>
                        <span style="width: 1px; height: 2.5vh; background: rgba(255,255,255,0.2); margin-right: 15px;"></span>
                        <span style="font-size: 2.5vh; color: rgba(255,255,255,0.9); font-weight: 400; font-family: monospace;">${time}</span>
                    </div>
                </div>

                <style>
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
                    @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
                    
                    /* Efeito de Onda - Safe */
                    @keyframes pulse-ring {
                        0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(${shadowRGB}, 0.8); }
                        100% { transform: scale(2); opacity: 0; box-shadow: 0 0 100px 50px rgba(${shadowRGB}, 0); }
                    }
                    
                    /* Efeito de Flash na Borda da Foto */
                    @keyframes border-flash {
                        0%, 100% { border-color: ${color}; box-shadow: 0 0 30px rgba(${shadowRGB}, 0.5); }
                        50% { border-color: white; box-shadow: 0 0 60px rgba(${shadowRGB}, 1); }
                    }
                </style>
            `;

            document.body.appendChild(overlay);

            // Som: "Ding Dong" Moderno (Mais alto e claro)
            // Som: "Ding Dong" Moderno (Mais alto e claro)
            const playSound = async () => {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    // Tenta usar o global desbloqueado ou cria um novo
                    const audioCtx = window.audioCtxGlobal || new AudioContext();

                    if (audioCtx.state === 'suspended') {
                        await audioCtx.resume();
                    }

                    const playTone = (freq, startTime, duration) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();

                        osc.type = 'sine';
                        osc.frequency.value = freq;

                        // Volume alto e sem fade-in lento para garantir ataque
                        gain.gain.setValueAtTime(0.1, startTime);
                        gain.gain.exponentialRampToValueAtTime(1.0, startTime + 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                        osc.connect(gain);
                        gain.connect(audioCtx.destination);

                        osc.start(startTime);
                        osc.stop(startTime + duration);
                    };

                    const now = audioCtx.currentTime;
                    // Ding (Mi)
                    playTone(660, now, 1.0);
                    // Dong (D√≥)
                    playTone(523, now + 0.8, 1.5);

                    // Vibra√ß√£o extra
                    if (navigator.vibrate) navigator.vibrate([500, 200, 500]);

                } catch (e) {
                    console.error("Erro ao tocar som:", e);
                }
            };
            playSound();

            // --- NOVO: VIBRA√á√ÉO E WAKE LOCK ---

            // 1. Vibrar (Padr√£o: Longo, Curto, Longo)
            if ('vibrate' in navigator) {
                try { navigator.vibrate([1000, 300, 1000, 300, 1000]); } catch (e) { }
            }

            // 2. Acordar a Tela (Wake Lock API)
            try {
                if ('wakeLock' in navigator) {
                    navigator.wakeLock.request('screen')
                        .then(lock => {
                            console.log('üí° Tela mantida acesa por Wake Lock');
                            // Soltar ap√≥s 15s (um pouco mais que a notifica√ß√£o)
                            setTimeout(() => lock.release(), 15000);
                        })
                        .catch(err => console.log('Wake Lock bloqueado:', err));
                }
            } catch (e) { }

            // 3. Disparar Notifica√ß√£o de Sistema (Ajuda a ligar a tela no Android)
            if (Notification.permission === 'granted' && document.hidden) {
                try {
                    const natif = new Notification(title, {
                        body: `${notif.student_name} - ${notif.school_name}`,
                        icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png', // Icone generico escolar
                        tag: 'school-alert',
                        vibrate: [1000, 300, 1000]
                    });
                    natif.onclick = () => {
                        window.focus();
                        natif.close();
                    };
                } catch (e) { }
            }

            // REMOVER AP√ìS 10 SEGUNDOS
            setTimeout(() => {
                overlay.style.animation = 'fadeOut 1s ease-out forwards'; // Sa√≠da mais lenta

                isCooldown = true;

                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.remove();
                    }
                }, 1000);

                setTimeout(() => { isCooldown = false; }, 10000);

            }, duration * 1000);
        }

        // Solicitar permiss√£o ao iniciar
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        }

        // Chamar ao carregar ou logar
        setTimeout(requestNotificationPermission, 2000);

        async function markAsRead(notificationId) {
            try {
                const token = localStorage.getItem('token');
                await fetch(`${API_URL}/guardian/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) { console.error('Erro ao marcar como lida:', error); }
        }

        function navigate(page) {
            // Ocultar todas as telas
            const screens = ['loginScreen', 'registerScreen', 'homeScreen', 'linkScreen', 'reportsScreen', 'notificationsScreen', 'messagesScreen', 'settingsScreen', 'chatScreen'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // Gerenciar menu inferior
            const bottomNav = document.getElementById('bottomNav');
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            // Navega√ß√£o
            if (page === 'home') {
                document.getElementById('homeScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                navItems[0].classList.add('active');
                loadChildren();
            }
            else if (page === 'reports') {
                document.getElementById('reportsScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                navItems[1].classList.add('active');
                loadReportScreen();
            }
            else if (page === 'notifications') {
                document.getElementById('notificationsScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                navItems[2].classList.add('active');
                console.log('üìå Navegando para Eventos...');
                loadEventsAndNotifications(); // Chamada cr√≠tica
            }
            else if (page === 'messages') {
                document.getElementById('messagesScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                navItems[3].classList.add('active');
                loadChatList();
            }
            else if (page === 'settings') {
                document.getElementById('settingsScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                navItems[4].classList.add('active');
                if (typeof loadSettings === 'function') loadSettings();
            }
            else if (page === 'link') {
                document.getElementById('linkScreen').classList.remove('hidden');
                bottomNav.classList.add('hidden');
                if (typeof resetLink === 'function') resetLink();
            }
        }

        function showLogin() {
            const screens = ['loginScreen', 'registerScreen', 'homeScreen', 'linkScreen', 'reportsScreen', 'notificationsScreen', 'messagesScreen', 'settingsScreen'];
            screens.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('bottomNav').classList.add('hidden');
        }

        function showRegister() {
            const screens = ['loginScreen', 'registerScreen', 'homeScreen', 'linkScreen', 'reportsScreen', 'notificationsScreen', 'messagesScreen', 'settingsScreen'];
            screens.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        function resetLink() {
            selectedSchool = null;
            selectedClass = null;
            selectedStudent = null;

            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.add('hidden');

            document.getElementById('schoolInput').value = '';
            document.getElementById('schoolResults').innerHTML = '';

            updateStep(1);
        }

        function updateStep(step) {
            const titles = ['Escola', 'Turma', 'Filho', 'Confirmar'];
            document.getElementById('stepTitle').textContent = `Passo ${step}: ${titles[step - 1]}`;

            for (let i = 1; i <= 4; i++) {
                document.getElementById(`bar${i}`).classList.toggle('active', i <= step);
            }
        }

        let schoolTimeout;
        async function searchSchools() {
            const query = document.getElementById('schoolInput').value.trim();

            if (query.length < 3) {
                document.getElementById('schoolResults').innerHTML = '';
                return;
            }

            clearTimeout(schoolTimeout);
            schoolTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`${API_URL}/guardian/schools?search=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    const schools = data; // O servidor retorna o array diretamente

                    const div = document.getElementById('schoolResults');

                    if (schools.length === 0) {
                        div.innerHTML = '<div class="result-item">Nenhuma escola encontrada</div>';
                    } else {
                        div.innerHTML = schools.map(s => `
                            <div class="result-item" onclick="selectSchool(${s.id}, '${s.name}')">
                                üè´ ${s.name}
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                }
            }, 300);
        }

        async function selectSchool(id, name) {
            selectedSchool = { id, name };
            document.getElementById('schoolInput').value = name;
            document.getElementById('schoolResults').innerHTML = '';

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            updateStep(2);

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/schools/${id}/classes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                // Servidor retorna array direto
                const classes = await res.json();
                const div = document.getElementById('classResults');

                if (classes.length === 0) {
                    div.innerHTML = '<div class="result-item">Nenhuma turma encontrada</div>';
                } else {
                    div.innerHTML = classes.map(c => `
                        <div class="result-item" onclick="selectClass('${c.name}')">
                            üìö ${c.name}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        function selectClass(name) {
            selectedClass = name;

            document.querySelectorAll('#classResults .result-item').forEach(item => {
                item.classList.toggle('selected', item.textContent.includes(name));
            });

            setTimeout(() => {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                updateStep(3);
            }, 300);
        }

        let studentTimeout;
        async function searchStudent() {
            const query = document.getElementById('studentInput').value.trim();
            const resultsDiv = document.getElementById('studentResults');

            if (query.length < 2) {
                if (resultsDiv) resultsDiv.innerHTML = '';
                return;
            }

            clearTimeout(studentTimeout);
            studentTimeout = setTimeout(async () => {
                try {
                    // Busca aluno na turma selecionada (endpoint p√∫blico)
                    const url = `${API_URL}/guardian/schools/${selectedSchool.id}/students/search?name=${encodeURIComponent(query)}&className=${encodeURIComponent(selectedClass)}`;
                    const res = await fetch(url);
                    const students = await res.json();

                    if (!resultsDiv) return;

                    if (students.length === 0) {
                        resultsDiv.innerHTML = '<div class="result-item" style="color: #999;">Nenhum aluno encontrado</div>';
                    } else {
                        resultsDiv.innerHTML = students.map(s => `
                            <div class="result-item" onclick="selectStudent(${JSON.stringify(s).replace(/"/g, '&quot;')})">
                                üë§ ${s.name}
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Erro na busca:', error);
                }
            }, 300);
        }

        function selectStudent(student) {
            selectedStudent = student;

            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
            updateStep(4);

            const photoDiv = document.getElementById('previewPhoto');
            if (selectedStudent.photo_url) {
                photoDiv.innerHTML = `<img src="${selectedStudent.photo_url}">`;
            } else {
                photoDiv.textContent = selectedStudent.name.charAt(0).toUpperCase();
            }

            document.getElementById('previewName').textContent = selectedStudent.name;
            document.getElementById('previewDetails').textContent = `${selectedClass} ‚Ä¢ ${selectedSchool.name}`;
        }


        async function confirmLink() {
            const errorDiv = document.getElementById('linkError');
            const successDiv = document.getElementById('linkSuccess');
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            const token = localStorage.getItem('token');

            // Verificar se est√° logado
            if (!token || !user) {
                errorDiv.textContent = '‚ùå Voc√™ precisa fazer login primeiro para vincular um filho.';
                errorDiv.classList.remove('hidden');
                setTimeout(() => {
                    showLogin();
                }, 2000);
                return;
            }

            try {
                const res = await fetch(`${API_URL}/guardian/link-student`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        school_id: selectedSchool.id,
                        student_id: selectedStudent.id
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        // Token inv√°lido - limpar e for√ßar re-login
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        user = null;
                        errorDiv.textContent = '‚ùå Sess√£o expirada. Redirecionando para login...';
                        errorDiv.classList.remove('hidden');
                        setTimeout(() => {
                            showLogin();
                        }, 1500);
                        return;
                    }
                    throw new Error(data.message || 'Erro ao vincular');
                }

                successDiv.textContent = `‚úÖ ${selectedStudent.name} vinculado com sucesso!`;
                successDiv.classList.remove('hidden');

                setTimeout(() => {
                    navigate('home');
                }, 2000);
            } catch (error) {
                errorDiv.textContent = `‚ùå ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        }


        async function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const password = document.getElementById('regPassword').value;

            const errorDiv = document.getElementById('registerError');
            const successDiv = document.getElementById('registerSuccess');
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            if (!name || !email || !password) {
                errorDiv.textContent = '‚ùå Preencha todos os campos';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/guardian/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, phone, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Erro ao cadastrar');
                }

                successDiv.textContent = '‚úÖ Conta criada!';
                successDiv.classList.remove('hidden');

                setTimeout(() => showLogin(), 2000);
            } catch (error) {
                errorDiv.textContent = `‚ùå ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.add('hidden');

            if (!email || !password) {
                errorDiv.textContent = '‚ùå Preencha todos os campos';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/guardian/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Credenciais inv√°lidas');
                }

                const token = data.data?.token || data.token;
                const userData = data.data?.guardian || data.user;

                if (!token || !userData) {
                    throw new Error('Resposta inv√°lida');
                }

                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(userData));
                user = userData;

                navigate('home');
            } catch (error) {
                errorDiv.textContent = `‚ùå ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        function logout() {
            stopNotificationPoller();
            localStorage.clear();
            user = null;
            showLogin();
        }

        async function loadChildren() {
            const token = localStorage.getItem('token');
            const div = document.getElementById('childrenList');

            try {
                const res = await fetch(`${API_URL}/guardian/students`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                const children = data.data?.students || [];
                myStudentsData = children;

                if (user) {
                    document.getElementById('greeting').textContent = `Ol√°, ${user.name.split(' ')[0]}!`;
                }

                if (!children || children.length === 0) {
                    div.innerHTML = `
                        <div class="empty">
                            <div class="empty-icon">üë∂</div>
                            <p class="empty-title">Nenhum filho vinculado</p>
                            <p class="empty-text">Clique abaixo para vincular</p>
                        </div>
                    `;
                    return;
                }

                div.innerHTML = children.map(child => {
                    const hasCoords = child.latitude && child.longitude;
                    return `
                        <div class="child-card" style="flex-direction: column; align-items: stretch; gap: 16px; padding: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="child-avatar">
                                    ${child.photo_url ? `<img src="${child.photo_url}">` : child.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="child-info">
                                    <div class="child-name">${child.name}</div>
                                    <div class="child-details">${child.class_name || 'Sem turma'} ‚Ä¢ ${child.school_name || ''}</div>
                                </div>
                            </div>
                            
                            <div class="pickup-container-${child.id}" style="margin-top: 4px;">
                                <div id="dist-info-${child.id}" style="font-size: 12px; color: #6b7280; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                    ${hasCoords ? '<span>üìç Calculando dist√¢ncia...</span>' : '<span style="color: #9ca3af;">üìç Localiza√ß√£o da escola n√£o configurada</span>'}
                                </div>
                                
                                <!-- Bot√£o principal: s√≥ ativo quando pr√≥ximo da escola -->
                                <button id="pickup-btn-${child.id}" 
                                        class="btn-primary" 
                                        style="width: 100%; background: #94a3b8; font-size: 14px; padding: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; border-radius: 12px; opacity: 0.6; cursor: not-allowed;"
                                        onclick="requestPickup(${child.id}, ${child.school_id})"
                                        disabled>
                                    üöó Aguardando aproxima√ß√£o...
                                </button>
                                
                                <!-- Bot√£o secund√°rio: autorizar de longe (outra pessoa buscar) -->
                                <button id="remote-btn-${child.id}" 
                                        class="btn-secondary" 
                                        style="width: 100%; margin-top: 8px; font-size: 13px; padding: 12px; display: none; align-items: center; justify-content: center; gap: 8px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);"
                                        onclick="requestRemotePickup(${child.id}, ${child.school_id}, '${child.name.replace(/'/g, "\\'")}')">
                                    ‚ö†Ô∏è Autorizar de Longe (Outra Pessoa Buscar)
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Iniciar monitoramento de dist√¢ncia se houver coordenadas
                children.forEach(child => {
                    if (child.latitude && child.longitude) {
                        startDistanceTracking(child);
                    }
                });

            } catch (error) {
                console.error('Erro:', error);
            }
        }

        const distanceTrackers = {};

        function startDistanceTracking(child) {
            if (distanceTrackers[child.id]) clearInterval(distanceTrackers[child.id]);

            const track = () => {
                if (!navigator.geolocation) return;

                navigator.geolocation.getCurrentPosition(position => {
                    const dist = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        child.latitude,
                        child.longitude
                    );

                    const infoDiv = document.getElementById(`dist-info-${child.id}`);
                    const btn = document.getElementById(`pickup-btn-${child.id}`);
                    const remoteBtn = document.getElementById(`remote-btn-${child.id}`);

                    // Calcular dist√¢ncia em metros
                    const distMeters = dist * 1000;

                    if (infoDiv) {
                        const distText = dist < 1 ? `${distMeters.toFixed(0)}m` : `${dist.toFixed(1)}km`;
                        const statusColor = distMeters <= 20 ? '#10b981' : (distMeters <= 200 ? '#f59e0b' : '#ef4444');
                        infoDiv.innerHTML = `<span style="color: ${statusColor};">üìç Voc√™ est√° a <b>${distText}</b> da escola</span>`;
                    }

                    if (btn) {
                        // REGRA: S√≥ ativa o bot√£o se estiver a <= 20 metros
                        if (distMeters <= 20) {
                            // PR√ìXIMO - Ativar bot√£o
                            btn.disabled = false;
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                            btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                            btn.style.boxShadow = '0 4px 20px rgba(16, 185, 129, 0.4)';
                            btn.innerHTML = '‚úÖ Estou na Escola - Notificar Chegada!';
                            btn.classList.add('pulse-animation');

                            // Esconder bot√£o de autoriza√ß√£o remota quando pr√≥ximo
                            if (remoteBtn) remoteBtn.style.display = 'none';

                        } else if (distMeters <= 200) {
                            // CHEGANDO (at√© 200m) - Ainda n√£o pode clicar, mas est√° perto
                            btn.disabled = true;
                            btn.style.opacity = '0.8';
                            btn.style.cursor = 'not-allowed';
                            btn.style.background = '#f59e0b';
                            btn.style.boxShadow = 'none';
                            btn.innerHTML = `üö∂ Aproxime-se mais (${distMeters.toFixed(0)}m)`;
                            btn.classList.remove('pulse-animation');

                            // Mostrar bot√£o de autoriza√ß√£o remota
                            if (remoteBtn) remoteBtn.style.display = 'flex';

                        } else {
                            // LONGE - Desativado, mostrar op√ß√£o de autoriza√ß√£o remota
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.style.cursor = 'not-allowed';
                            btn.style.background = '#94a3b8';
                            btn.style.boxShadow = 'none';
                            btn.style.transform = 'scale(1)';
                            btn.innerHTML = 'üöó V√° at√© a escola para notificar';
                            btn.classList.remove('pulse-animation');

                            // Mostrar bot√£o de autoriza√ß√£o remota
                            if (remoteBtn) remoteBtn.style.display = 'flex';
                        }
                    }
                }, err => {
                    console.error('Erro de geo:', err);
                    // Se n√£o conseguir localiza√ß√£o, mostrar bot√£o de autoriza√ß√£o remota
                    const remoteBtn = document.getElementById(`remote-btn-${child.id}`);
                    if (remoteBtn) remoteBtn.style.display = 'flex';
                }, { enableHighAccuracy: true, timeout: 10000 });
            };

            track();
            distanceTrackers[child.id] = setInterval(track, 5000); // Atualiza a cada 5 segundos
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function requestPickup(studentId, schoolId) {
            const btn = document.getElementById(`pickup-btn-${studentId}`);
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = 'Enviando...';

                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/pickup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ student_id: studentId, school_id: schoolId })
                });

                const data = await res.json();
                if (data.success) {
                    btn.style.background = '#059669';
                    btn.innerHTML = '‚úÖ Notificado!';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }, 5000);
                } else {
                    alert(data.message || 'Erro ao notificar');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                alert('Erro na conex√£o');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Fun√ß√£o para autoriza√ß√£o remota (quando respons√°vel est√° longe e outra pessoa vai buscar)
        async function requestRemotePickup(studentId, schoolId, studentName) {
            // Mostrar modal de confirma√ß√£o
            const confirmed = confirm(
                `‚ö†Ô∏è ATEN√á√ÉO: AUTORIZA√á√ÉO REMOTA\n\n` +
                `Voc√™ est√° longe da escola e est√° autorizando a retirada de:\n\n` +
                `üë§ ${studentName}\n\n` +
                `Isso significa que OUTRA PESSOA ir√° buscar seu filho(a) na escola.\n\n` +
                `A escola ser√° notificada de que voc√™ autorizou a retirada remotamente.\n\n` +
                `Deseja realmente autorizar?`
            );

            if (!confirmed) {
                return; // Usu√°rio cancelou
            }

            const btn = document.getElementById(`remote-btn-${studentId}`);
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Enviando autoriza√ß√£o...';

                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/pickup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        school_id: schoolId,
                        remote_authorization: true // Flag indicando que foi autoriza√ß√£o remota
                    })
                });

                const data = await res.json();
                if (data.success) {
                    btn.style.background = 'rgba(16, 185, 129, 0.2)';
                    btn.style.color = '#10b981';
                    btn.style.border = '1px solid #10b981';
                    btn.innerHTML = '‚úÖ Autoriza√ß√£o enviada!';

                    // Mostrar alerta de sucesso
                    alert(`‚úÖ Autoriza√ß√£o remota enviada!\n\nA escola foi notificada que voc√™ autorizou a retirada de ${studentName}.\n\nLembre-se: Somente pessoas autorizadas poder√£o retirar.`);

                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.background = 'rgba(239, 68, 68, 0.1)';
                        btn.style.color = '#ef4444';
                        btn.style.border = '1px solid rgba(239, 68, 68, 0.2)';
                    }, 10000);
                } else {
                    alert(data.message || 'Erro ao enviar autoriza√ß√£o');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                alert('Erro na conex√£o. Tente novamente.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- RELAT√ìRIOS ---
        function loadReportScreen() {
            const select = document.getElementById('reportStudentSelect');
            if (myStudentsData.length === 0) {
                select.innerHTML = '<option>Sem alunos vinculados</option>';
                return;
            }

            select.innerHTML = myStudentsData.map(student =>
                `<option value="${student.id}">${student.name}</option>`
            ).join('');

            loadStudentReport();
        }

        function changeReportMonth(delta) {
            currentReportDate.setMonth(currentReportDate.getMonth() + delta);
            loadStudentReport();
        }

        async function loadStudentReport() {
            const studentId = document.getElementById('reportStudentSelect').value;
            if (!studentId) return;

            const student = myStudentsData.find(s => s.id == studentId);
            if (!student) return;

            // Atualizar Label
            document.getElementById('reportMonthLabel').textContent = currentReportDate.toLocaleDateString('pt-BR', { month: 'long' });
            document.getElementById('reportYearLabel').textContent = currentReportDate.getFullYear();

            // Buscar dados
            const month = currentReportDate.getMonth() + 1;
            const year = currentReportDate.getFullYear();

            try {
                const token = localStorage.getItem('token');
                // Usar student.schoolId que veio do endpoint my-students
                const res = await fetch(`${API_URL}/guardian/student-attendance?schoolId=${student.schoolId}&studentId=${studentId}&month=${month}&year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const attendanceData = await res.json();
                renderCalendar(attendanceData || []);
            } catch (e) {
                console.error("Erro ao report:", e);
            }
        }

        function renderCalendar(attendanceData) {
            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            const year = currentReportDate.getFullYear();
            const month = currentReportDate.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // Empty slots for start
            for (let i = 0; i < firstDay.getDay(); i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day day-empty';
                container.appendChild(div);
            }

            // Days
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];

                // Verificar presen√ßa (Entry/Arrival)
                // attendanceData tem timestamp ISO. Converter para YYYY-MM-DD local se poss√≠vel ou bater dates
                const hasRecord = attendanceData.some(r => {
                    const rDate = new Date(r.timestamp);
                    return rDate.getDate() === day && rDate.getMonth() === month;
                });

                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.textContent = day;

                // Estilo
                if (date.toDateString() === today.toDateString()) {
                    div.classList.add('day-today');
                }

                if (hasRecord) {
                    div.classList.add('day-present');
                    div.title = 'Presente';
                } else if (date < today && date.getDay() !== 0 && date.getDay() !== 6) {
                    div.classList.add('day-absent');
                    // Fim de semana check simples
                }
                container.appendChild(div);
            }
        }

        // --- EVENTOS E NOTIFICA√á√ïES DA ESCOLA ---
        async function loadEventsAndNotifications() {
            const eventsListDiv = document.getElementById('eventsList');
            const eventsEmptyDiv = document.getElementById('eventsEmpty');

            // Visual simples como solicitado ("como ontem")
            eventsListDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Carregando...</p>';
            eventsEmptyDiv.classList.add('hidden');

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showLogin();
                    return;
                }

                console.log('üîÑ Sincronizando eventos com o servidor...');
                const res = await fetch(`${API_URL} /guardian/school - events`, {
                    headers: { 'Authorization': `Bearer ${token} ` }
                });

                if (res.status === 401 || res.status === 403) {
                    localStorage.clear();
                    showLogin();
                    return;
                }

                if (!res.ok) throw new Error(`Erro API: ${res.status} `);

                const data = await res.json();
                const events = data.events || [];
                console.log(`‚úÖ Recebidos ${events.length} eventos.`);

                if (events.length === 0) {
                    eventsListDiv.innerHTML = '';
                    eventsEmptyDiv.classList.remove('hidden');
                    return;
                }

                // Renderizar eventos
                eventsListDiv.innerHTML = events.map(event => {
                    const d = event.event_date ? new Date(event.event_date) : null;
                    const dateStr = d ? d.toLocaleDateString('pt-BR') : 'Data a confirmar';
                    const hasCost = event.cost && parseFloat(event.cost) > 0;

                    return `
                    < div class="event-card" >
                            <div class="event-header">
                                <h3 class="event-title">${event.title || 'Evento'}</h3>
                                ${hasCost ? `<span class="badge-cost">R$ ${parseFloat(event.cost).toFixed(2)}</span>` : ''}
                            </div>
                            <p class="event-desc">${event.description || ''}</p>
                            <div class="event-meta">
                                <span>üìÖ ${dateStr}</span>
                                <span>üè´ ${event.school_name || 'Escola'}</span>
                                ${event.class_name ? `<span>üìö ${event.class_name}</span>` : '<span>üë• Geral</span>'}
                            </div>
                             ${event.pix_key ? `
                                <div class="pix-box">
                                    <strong>Pix:</strong> ${event.pix_key}
                                </div>
                            ` : ''
                        }
                        </div >
                    `;
                }).join('');

            } catch (error) {
                console.error('Falha nos eventos:', error);
                eventsListDiv.innerHTML = `
                    < div style = "text-align:center; padding:20px; color:#ef4444;" >
                        <p>N√£o foi poss√≠vel atualizar os eventos.</p>
                        <button onclick="loadEventsAndNotifications()" style="margin-top:10px; padding:8px 16px; background:#ef4444; color:white; border:none; border-radius:8px;">Tentar Novamente</button>
                    </div >
                    `;
            }
        }

        // --- CHAT SYSTEM ---
        function loadChatList() {
            const list = document.getElementById('chatList');
            const empty = document.getElementById('emptyChat');

            if (!myStudentsData || myStudentsData.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            list.innerHTML = myStudentsData.map(s => `
                    < div class="chat-list-item" onclick = "openChat(${s.id})" >
                    <div class="child-avatar">
                        ${s.photo_url ? `<img src="${s.photo_url}">` : s.name.charAt(0)}
                    </div>
                    <div style="flex: 1;">
                        <div class="child-name">${s.name}</div>
                        <div class="child-details">${s.schoolName || 'Escola'}</div>
                    </div>
                    <div style="font-size: 20px; color: #ddd;">‚Ä∫</div>
                </div >
                    `).join('');
        }

        async function openChat(studentId) {
            activeChatStudentId = studentId;
            const student = myStudentsData.find(s => s.id == studentId);
            if (!student) return;

            // UI Setup
            document.getElementById('messagesScreen').classList.add('hidden');
            document.getElementById('bottomNav').classList.add('hidden');
            document.getElementById('chatScreen').classList.remove('hidden');
            document.getElementById('chatStudentName').textContent = student.name;
            document.getElementById('chatSchoolName').textContent = student.schoolName || 'Escola';

            // Logic
            fetchMessages();
            if (chatPollInterval) clearInterval(chatPollInterval);
            chatPollInterval = setInterval(fetchMessages, 3000); // Poll every 3s

            // Input logic toggle
            const input = document.getElementById('messageInput');
            input.oninput = () => {
                const mic = document.getElementById('micBtn');
                const send = document.getElementById('sendBtn');
                if (input.value.trim().length > 0) {
                    mic.style.display = 'none';
                    send.style.display = 'block';
                } else {
                    mic.style.display = 'block';
                    send.style.display = 'none';
                }
            };
        }

        function closeChat() {
            activeChatStudentId = null;
            if (chatPollInterval) clearInterval(chatPollInterval);

            document.getElementById('chatScreen').classList.add('hidden');
            document.getElementById('messagesScreen').classList.remove('hidden');
            document.getElementById('bottomNav').classList.remove('hidden');
        }

        async function fetchMessages() {
            if (!activeChatStudentId) return;
            const student = myStudentsData.find(s => s.id == activeChatStudentId);

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL} /guardian/chat / ${activeChatStudentId}/messages?schoolId=${student.schoolId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const msgs = await res.json();
                renderMessages(msgs);
            } catch (e) { console.error(e); }
        }

        function renderMessages(messages) {
            const container = document.getElementById('chatMessages');
            // Check if user is near bottom to auto-scroll
            const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;

            // Map messages
            const html = messages.map(msg => {
                const isMe = msg.sender_type === 'guardian';
                let contentHtml = '';

                // Adjust URL (API_URL usually http://localhost:3000/api -> server http://localhost:5000)
                // Need base url. API_URL might be /api relative if proxied or absolute.
                // Assuming files are served at root /uploads, and API_URL is /api.
                // We need to strip /api or use a global SERVER_URL.
                // Hacks: replace '/api' with '' if it is a path info. 
                // But wait, API_URL in index.html is defined at top.
                // Let's assume file_url comes as `/uploads/...` from server.
                // We need server origin.
                // If API_URL is `http://localhost:5000/api`, then server origin is `http://localhost:5000`.
                const serverOrigin = API_URL.replace('/api', '');

                if (msg.message_type === 'text') {
                    contentHtml = msg.content;
                } else if (msg.message_type === 'image') {
                    contentHtml = `<img src="${serverOrigin}${msg.file_url}" class="chat-img-preview" onclick="window.open(this.src)">`;
                    if (msg.content) contentHtml += `<div style="margin-top:4px">${msg.content}</div>`;
                } else if (msg.message_type === 'audio') {
                    contentHtml = `<audio controls src="${serverOrigin}${msg.file_url}" class="chat-audio"></audio>`;
                } else {
                    contentHtml = `<a href="${serverOrigin}${msg.file_url}" target="_blank">üìé ${msg.file_name || 'Arquivo'}</a>`;
                }

                const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="chat-bubble ${isMe ? 'sent' : 'received'}">
                        ${contentHtml}
                        <div class="chat-time">${time}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;

            if (isNearBottom || messages.length > 0) { // Simple scroll logic
                container.scrollTop = container.scrollHeight;
            }
        }

        async function sendMessage(file = null, type = 'text') {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content && !file) return;

            const student = myStudentsData.find(s => s.id == activeChatStudentId);
            const token = localStorage.getItem('token');

            const formData = new FormData();
            formData.append('schoolId', student.schoolId);
            if (content) formData.append('content', content);
            if (file) formData.append('file', file);
            formData.append('type', type);

            try {
                // Optimistic UI update could be here
                input.value = '';
                document.getElementById('micBtn').style.display = 'block';
                document.getElementById('sendBtn').style.display = 'none';

                await fetch(`${API_URL}/guardian/chat/${activeChatStudentId}/messages`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                fetchMessages();
            } catch (e) {
                alert('Erro ao enviar');
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Determine type
            let type = 'file';
            if (file.type.startsWith('image/')) type = 'image';
            if (file.type.startsWith('audio/')) type = 'audio';

            if (confirm(`Enviar ${file.name}?`)) {
                sendMessage(file, type);
            }
            input.value = ''; // Reset
        }

        // --- AUDIO RECORDING ---
        function startRecording() {
            if (!navigator.mediaDevices) {
                alert('Audio n√£o suportado neste navegador/contexto');
                return;
            }
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];

                    document.getElementById('micBtn').style.color = 'red';

                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); // Chrome uses webm
                        const file = new File([audioBlob], `audio_${Date.now()}.webm`, { type: 'audio/webm' });
                        sendMessage(file, 'audio');
                        document.getElementById('micBtn').style.color = '#54656f';
                    });
                });
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        async function loadEventsAndNotifications() {
            const list = document.getElementById('eventsList');
            const empty = document.getElementById('eventsEmpty');
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;">Carregando...</div>';
            empty.style.display = 'none';

            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const res = await fetch(`${API_URL}/guardian/events`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Falha ao buscar eventos');

                const events = await res.json();

                list.innerHTML = '';

                if (events.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                events.forEach(e => {
                    const date = new Date(e.event_date || e.created_at).toLocaleDateString('pt-BR');
                    const cost = e.cost ? `R$ ${e.cost.toFixed(2)}` : 'Gratuito';
                    const paymentDeadline = e.payment_deadline ? new Date(e.payment_deadline).toLocaleDateString('pt-BR') : null;

                    const div = document.createElement('div');
                    div.className = 'event-card';

                    // Bot√µes de a√ß√£o
                    let actionsHtml = '';

                    // Primeiro: Tenho Interesse (roxo)
                    actionsHtml += `<button onclick="participate(${e.id}, ${e.schoolId}, 'interested')" style="flex:1; padding:10px; border:none; color:white; background:#8b5cf6; border-radius:8px; font-weight:600; font-size:13px;">üëã Tenho Interesse</button>`;

                    // Se tiver custo, mostra bot√£o de pagamento
                    if (e.cost > 0 || e.pix_key) {
                        actionsHtml += `<button onclick="participate(${e.id}, ${e.schoolId}, 'inform_payment')" style="flex:1; padding:10px; border:none; color:white; background:#10b981; border-radius:8px; font-weight:600; font-size:13px;">üí∞ J√° Paguei</button>`;
                    }

                    div.innerHTML = `
                        <div class="event-header">
                            <div class="event-title">${e.title}</div>
                            <div class="event-date">üìÖ ${date}</div>
                        </div>
                        <div class="event-desc">${e.description || ''}</div>

                        ${e.cost > 0 ? `<div style="background:#dcfce7; padding:10px; border-radius:8px; margin:10px 0; border:1px solid #86efac;">
                            <div style="color:#166534; font-weight:bold; font-size:16px;">üíµ Valor: ${cost}</div>
                            ${paymentDeadline ? `<div style="color:#dc2626; font-size:13px; margin-top:4px;">‚ö†Ô∏è Pagar at√©: ${paymentDeadline}</div>` : ''}
                        </div>` : ''}

                        ${e.pix_key ? `<div style="background:#fffbeb; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #fcd34d;">
                            <div style="color:#92400e; font-size:12px; font-weight:600;">CHAVE PIX PARA PAGAMENTO:</div>
                            <div style="color:#b45309; font-size:14px; word-break:break-all; margin-top:4px; font-family:monospace;">${e.pix_key}</div>
                        </div>` : ''}

                        <div class="event-footer">
                            <div class="event-school">üè´ ${e.school_name || 'Escola'}</div>
                            ${e.class_name ? `<div style="background:#e0e7ff; color:#4338ca; padding:2px 8px; border-radius:4px; font-size:11px;">Turma ${e.class_name}</div>` : '<div style="background:#f0fdf4; color:#166534; padding:2px 8px; border-radius:4px; font-size:11px;">Toda Escola</div>'}
                        </div>
                        <div style="margin-top:12px; display:flex; gap:8px;">
                            ${actionsHtml}
                        </div>
                    `;
                    list.appendChild(div);
                });

            } catch (e) {
                console.error(e);
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#ef4444;">Erro ao carregar avisos.</div>';
            }
        }

        async function participate(evtId, schoolId, action) {
            // Confirma√ß√£o simples
            const labels = {
                'interested': 'informar interesse neste evento',
                'inform_payment': 'confirmar que j√° realizou o pagamento',
                'confirm_presence': 'confirmar presen√ßa'
            };
            const label = labels[action] || 'participar';
            if (!confirm(`Deseja ${label}? A escola ser√° notificada.`)) return;

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/events/${evtId}/participate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ schoolId, action })
                });

                if (res.ok) {
                    alert('Confirma√ß√£o enviada com sucesso!');
                } else {
                    const err = await res.json();
                    alert('Erro: ' + (err.error || 'Falha ao enviar'));
                }
            } catch (e) {
                console.error('Erro:', e);
                alert('Erro de conex√£o');
            }
        }
    </script>
</body>

</html>