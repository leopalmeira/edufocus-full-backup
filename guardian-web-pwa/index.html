<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <title>EduFocus Respons√°veis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --radius-md: 12px;
            --radius-lg: 20px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        @keyframes badge-attention {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
                opacity: 0;
            }

            50% {
                transform: scale(1.3);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                opacity: 1;
            }
        }

        .nav-badge {
            position: absolute;
            top: 2px;
            right: 50%;
            margin-right: -25px;
            background: var(--danger);
            color: white;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            animation: badge-attention 1.5s ease forwards;
            z-index: 10;
        }

        @keyframes pulse-soft {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 80px;
            /* Space for nav */
        }

        .container {
            max-width: 480px;
            /* Slightly wider */
            margin: 0 auto;
            background: var(--bg-body);
            min-height: 100vh;
            position: relative;
        }

        /* Header Professional */
        .header {
            background: var(--text-main);
            /* Dark Slate */
            padding: 24px 24px 32px;
            /* Taller header */
            color: white;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 10;
        }

        .header-greeting {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 13px;
            color: #94a3b8;
            /* Slate 400 */
            font-weight: 500;
        }

        /* Content */
        .content {
            padding: 20px;
            margin-top: -10px;
            /* Pull up to overlap header slightly if needed, or 0 */
            position: relative;
            z-index: 20;
        }

        /* Cards */
        .card,
        .child-card,
        .event-card,
        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .child-card {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .child-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #eff6ff;
            /* Blue 50 */
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .child-info {
            flex: 1;
        }

        .child-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 2px;
        }

        .child-details {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn-primary,
        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 14px;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
            transition: all 0.2s;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 20px;
            /* Safe area bottom */
            max-width: 480px;
            margin: 0 auto;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active .nav-icon {
            transform: translateY(-2px);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            top: 0;
            width: 20px;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 4px 4px;
        }

        .nav-icon {
            font-size: 22px;
            transition: transform 0.2s;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
        }

        /* Academic Tabs */
        .tabs-header {
            display: flex;
            background: var(--surface);
            padding: 4px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .child-card-prof {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
            overflow: hidden;
            /* Contain children */
            transition: all 0.3s ease;
        }

        /* CALLING ANIMATION - When inspector is calling the student */
        .child-card-prof.calling-animation {
            border: 3px solid #f59e0b !important;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3), 0 0 30px rgba(245, 158, 11, 0.4) !important;
            animation: calling-pulse 1.5s ease-in-out infinite;
        }

        .child-card-prof.calling-animation::before {
            content: 'üì¢ SENDO CHAMADO!';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 1px;
            animation: calling-flash 0.8s ease-in-out infinite;
            z-index: 10;
        }

        .child-card-prof.calling-animation .child-card-header {
            margin-top: 36px;
        }

        @keyframes calling-pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3), 0 0 30px rgba(245, 158, 11, 0.4);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 0 0 8px rgba(245, 158, 11, 0.2), 0 0 50px rgba(245, 158, 11, 0.6);
            }
        }

        @keyframes calling-flash {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Waiting for call animation */
        .waiting-call-animation {
            animation: waiting-pulse 2s ease-in-out infinite;
        }

        @keyframes waiting-pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.85;
                transform: scale(0.98);
            }
        }

        /* Calling button animation */
        .calling-btn-animation {
            animation: calling-btn-pulse 0.8s ease-in-out infinite !important;
        }

        @keyframes calling-btn-pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 4px 25px rgba(245, 158, 11, 0.6);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 8px 40px rgba(245, 158, 11, 0.9);
            }
        }

        .child-card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            z-index: 2;
        }

        .child-avatar-prof {
            width: 60px !important;
            height: 60px !important;
            min-width: 60px !important;
            border-radius: 50%;
            background: #eff6ff;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            flex-shrink: 0;
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--primary);
            overflow: hidden;
            position: relative;
        }

        .child-avatar-prof img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            display: block;
        }

        .child-info-prof {
            flex: 1;
            min-width: 0;
            /* Text truncation fix */
        }

        .child-name-prof {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .child-details-prof {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .btn-msg-prof {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.6;
            transition: opacity 0.2s;
            padding: 5px;
            flex-shrink: 0;
        }

        .btn-msg-prof:hover {
            opacity: 1;
        }

        .btn-pickup {
            width: 100%;
            background: #cbd5e1;
            /* Slate 300 - Disabled state */
            color: #475569;
            font-weight: 600;
            font-size: 15px;
            padding: 14px;
            border-radius: var(--radius-md);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: not-allowed;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-pickup:not(:disabled) {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transform: translateY(0);
        }

        .btn-pickup:not(:disabled):active {
            transform: translateY(2px);
        }

        .btn-remote-pickup {
            width: 100%;
            background: #fef2f2;
            color: #ef4444;
            border: 1px solid #fee2e2;
            padding: 12px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }



        /* Empty State */
        .empty {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.2;
        }

        .empty-title {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .empty-text {
            font-size: 13px;
            color: #6b7280;
        }

        /* Login/Register */
        /* Login/Register - Professional Redesign */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: url('bg-login.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            padding: 20px;
        }

        /* Overlay escuro para melhorar leitura e contraste sobre a foto */
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.70);
            /* Dark Blue/Slate overlay */
            backdrop-filter: blur(4px);
            z-index: 1;
        }

        /* Wrapper para centralizar e elevar sobre o overlay */
        .auth-wrapper {
            position: relative;
            z-index: 2;
            width: 100%;
            max-width: 440px;
            margin: 0 auto;
        }

        .auth-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 40px 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.5);
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
            color: #1e293b;
        }

        .auth-logo {
            font-size: 56px;
            margin-bottom: 12px;
            line-height: 1;
            /* Efeito de brilho no emoji/logo */
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        .auth-title {
            font-size: 28px;
            font-weight: 800;
            color: #1e293b;
            /* Slate 800 */
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .auth-subtitle {
            font-size: 15px;
            color: #64748b;
            /* Slate 500 */
            font-weight: 500;
        }

        /* Estiliza√ß√£o melhorada dos Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .input {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
        }

        .input:focus {
            outline: none;
            border-color: #6366f1;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: #6366f1;
            color: white;
            cursor: pointer;
        }

        .link {
            text-align: center;
            margin-top: 16px;
            font-size: 13px;
            color: #6b7280;
        }

        .link a {
            color: #6366f1;
            text-decoration: none;
            font-weight: 600;
        }

        .alert {
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .hidden {
            display: none !important;
        }

        /* Link Flow */
        .steps {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
        }

        .step {
            flex: 1;
            height: 3px;
            background: #e5e7eb;
            border-radius: 2px;
        }

        .step.active {
            background: #6366f1;
        }

        .result-item {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .result-item.selected {
            background: #ede9fe;
            border-color: #6366f1;
        }

        .preview {
            text-align: center;
            padding: 24px;
            background: #f9fafb;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .preview-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 12px;
            background: #6366f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            font-weight: 600;
        }

        .preview-photo img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .preview-name {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .preview-details {
            font-size: 13px;
            color: #6b7280;
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: #f3f4f6;
            color: #374151;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 11px;
            color: #6b7280;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
        }

        /* Chat Styles */
        .chat-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            background: white;
            transition: background 0.2s;
        }

        .chat-list-item:active {
            background: #f9fafb;
        }

        /* Chat Styles */
        #chatScreen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .chat-screen-content {
            background: #e5ddd5;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding-bottom: 0;
            min-height: 0;
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            padding-bottom: 80px;
            /* Space for input bar */
        }

        .chat-bubble {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .chat-bubble.sent {
            background: #dcf8c6;
            align-self: flex-end;
            margin-left: auto;
            border-top-right-radius: 0;
        }

        .chat-bubble.received {
            background: white;
            align-self: flex-start;
            margin-right: auto;
            border-top-left-radius: 0;
        }

        .chat-time {
            font-size: 10px;
            color: #999;
            text-align: right;
            margin-top: 4px;
        }

        .date-divider {
            text-align: center;
            margin: 15px 0 5px;
            font-size: 11px;
            color: #9ca3af;
            background: rgba(0, 0, 0, 0.05);
            padding: 4px 12px;
            border-radius: 12px;
            align-self: center;
            width: fit-content;
        }

        /* Cards de Eventos */
        .event-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .event-title {
            font-weight: 700;
            font-size: 16px;
            color: #111827;
            margin: 0;
        }

        .badge-cost {
            background: #ecfdf5;
            color: #059669;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .event-desc {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .event-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .event-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .event-footer {
            border-top: 1px solid #f3f4f6;
            padding-top: 8px;
            font-size: 12px;
            color: #9ca3af;
        }

        .pix-box {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 10px;
            margin-top: 12px;
            font-size: 13px;
            color: #92400e;
        }

        /* ... outros estilos ... */
        .chat-input-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 440px;
            background: #f0f2f5;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-top: 1px solid #ddd;
            z-index: 1000;
        }

        .chat-input {
            flex: 1;
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            background: #fff;
            font-family: inherit;
            outline: none;
            height: 40px;
            /* Consistent height */
        }

        .chat-input:focus {
            outline: none;
        }

        .chat-btn-icon {
            background: none;
            border: none;
            font-size: 24px;
            color: #54656f;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        /* Specific styles for Mic and Send buttons (Green Circle) */
        #micBtn,
        #sendBtn {
            background: #00a884;
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            min-width: 45px;
            padding: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            font-size: 20px;
        }

        #sendBtn {
            /* Keep original color override or use green? WhatsApp uses green circle for send/mic */
            /* Previous code had style="color: #6366f1" inline. I should override this carefully or effectively */
            color: white !important;
            /* Force white icon on green bg */
        }

        .chat-img-preview {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .chat-audio {
            width: 200px;
        }

        /* Hide bottom nav when in chat */
        .hidden-nav .bottom-nav {
            display: none !important;
        }

        /* Logout Button */
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.05);
        }

        .logout-btn:active {
            transform: scale(0.95);
        }


        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 20px;
        }

        .calendar-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border-radius: 8px;
            position: relative;
        }

        .day-present {
            background: #d1fae5;
            color: #065f46;
            font-weight: 600;
        }

        .day-absent {
            background: #fee2e2;
            color: #991b1b;
            font-weight: 600;
        }

        .day-empty {
            background: transparent;
        }

        .day-today {
            border: 2px solid #6366f1;
        }



        .event-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .event-title {
            font-weight: 600;
            font-size: 16px;
            color: #111827;
        }

        .event-date {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .event-desc {
            font-size: 14px;
            color: #4b5563;
            margin-bottom: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .event-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #f3f4f6;
            padding-top: 12px;
        }

        .event-school {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .event-cost {
            font-weight: 600;
            color: #059669;
            font-size: 14px;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 18px;
            padding: 8px;
            cursor: pointer;
            color: #6366f1;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="auth-container">
                <div class="auth-wrapper">
                    <div class="auth-content">
                        <div class="auth-header">
                            <div class="auth-logo">üì±</div>
                            <h1 class="auth-title">EduFocus</h1>
                            <p class="auth-subtitle">Acompanhe seu filho</p>
                        </div>
                        <div id="loginError" class="alert alert-error hidden"></div>
                        <div class="form-group">
                            <label class="label">Email</label>
                            <input type="email" id="loginEmail" class="input" placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label class="label">Senha</label>
                            <input type="password" id="loginPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button class="btn-primary" onclick="login()">Entrar</button>
                        <div class="link">
                            N√£o tem conta? <a href="#" onclick="showRegister()">Cadastre-se</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="hidden">
            <div class="auth-container">
                <div class="auth-wrapper">
                    <div class="auth-content">
                        <div class="auth-header">
                            <div class="auth-logo">‚ú®</div>
                            <h1 class="auth-title">Criar Conta</h1>
                            <p class="auth-subtitle">Preencha seus dados</p>
                        </div>
                        <div id="registerError" class="alert alert-error hidden"></div>
                        <div id="registerSuccess" class="alert alert-success hidden"></div>
                        <div class="form-group">
                            <label class="label">Nome Completo</label>
                            <input type="text" id="regName" class="input" placeholder="Jo√£o Silva">
                        </div>
                        <div class="form-group">
                            <label class="label">Email</label>
                            <input type="email" id="regEmail" class="input" placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label class="label">Telefone</label>
                            <input type="tel" id="regPhone" class="input" placeholder="(11) 99999-9999">
                        </div>
                        <div class="form-group">
                            <label class="label">Senha</label>
                            <input type="password" id="regPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button class="btn-primary" onclick="register()">Criar Conta</button>
                        <div class="link">
                            <a href="#" onclick="showLogin()">‚Üê Voltar</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="homeScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting" id="greeting">Ol√°!</h1>
                <p class="header-subtitle">Meus Filhos</p>
            </div>
            <div class="content">
                <div id="childrenList"></div>
                <button class="add-btn" onclick="navigate('link')">+ Vincular Filho</button>
            </div>
        </div>

        <!-- Link Screen -->
        <div id="linkScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Vincular Filho</h1>
                <p class="header-subtitle" id="stepTitle">Passo 1: Escola</p>
            </div>
            <div class="content">
                <div class="steps">
                    <div class="step active" id="bar1"></div>
                    <div class="step" id="bar2"></div>
                    <div class="step" id="bar3"></div>
                    <div class="step" id="bar4"></div>
                </div>

                <div id="linkError" class="alert alert-error hidden"></div>
                <div id="linkSuccess" class="alert alert-success hidden"></div>

                <div id="step1">
                    <div class="form-group">
                        <label class="label">Nome da escola</label>
                        <input type="text" id="schoolInput" class="input" placeholder="Digite o nome..."
                            oninput="searchSchools()">
                    </div>
                    <div id="schoolResults"></div>
                </div>

                <div id="step2" class="hidden">
                    <div class="form-group">
                        <label class="label">Turma</label>
                        <div id="classResults"></div>
                    </div>
                </div>

                <div id="step3" class="hidden">
                    <div class="form-group">
                        <label class="label">Nome completo do filho</label>
                        <input type="text" id="studentInput" class="input" placeholder="Digite o nome..."
                            oninput="searchStudent()">
                    </div>
                    <div id="studentResults"></div>
                </div>

                <div id="step4" class="hidden">
                    <div class="preview">
                        <div class="preview-photo" id="previewPhoto">?</div>
                        <div class="preview-name" id="previewName">-</div>
                        <div class="preview-details" id="previewDetails">-</div>
                    </div>
                    <button class="btn-primary" onclick="confirmLink()">Confirmar</button>
                </div>

                <button class="btn-secondary" onclick="navigate('home')">Voltar</button>
            </div>
        </div>

        <!-- Academic Screen (Merged Reports, Grades, Notes) -->
        <div id="academicScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Acad√™mico</h1>
                <p class="header-subtitle">Acompanhamento Escolar</p>
            </div>
            <div class="content">

                <div class="tabs-header">
                    <div class="tab-btn active" id="tabBtnAttendance" onclick="switchAcademicTab('attendance')">
                        Frequ√™ncia</div>
                    <div class="tab-btn" id="tabBtnGrades" onclick="switchAcademicTab('grades')">Notas</div>
                    <div class="tab-btn" id="tabBtnReports" onclick="switchAcademicTab('reports')">Relat√≥rios</div>
                </div>

                <!-- ATTENDANCE TAB -->
                <div id="tabAttendanceContent">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label">Filho</label>
                        <select id="reportStudentSelect" class="input" onchange="loadReportStudent(this.value)">
                            <option value="">Selecione...</option>
                        </select>
                    </div>

                    <!-- Stats Grid Removed by Request -->

                    <!-- Calendar Controls -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <button class="btn-icon" onclick="changeReportMonth(-1)">‚óÄ</button>
                        <div style="text-align: center;">
                            <span id="reportMonthLabel"
                                style="font-size: 16px; font-weight: 600; display: block;">-</span>
                            <span id="reportYearLabel" style="font-size: 12px; color: #6b7280;">-</span>
                        </div>
                        <button class="btn-icon" onclick="changeReportMonth(1)">‚ñ∂</button>
                    </div>

                    <!-- Stat Cards - Presen√ßas e Faltas -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div onclick="showAttendanceModal('present')"
                            style="background: linear-gradient(135deg, #10b981, #059669); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); cursor: pointer; transition: transform 0.2s;">
                            <div style="font-size: 36px; font-weight: 900; color: white;" id="presenceCount">0</div>
                            <div
                                style="font-size: 13px; color: rgba(255,255,255,0.9); font-weight: 600; margin-top: 4px;">
                                ‚úÖ Presen√ßas</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 8px;">Clique para ver
                                detalhes</div>
                        </div>
                        <div onclick="showAttendanceModal('absent')"
                            style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); cursor: pointer; transition: transform 0.2s;">
                            <div style="font-size: 36px; font-weight: 900; color: white;" id="absenceCount">0</div>
                            <div
                                style="font-size: 13px; color: rgba(255,255,255,0.9); font-weight: 600; margin-top: 4px;">
                                ‚ùå Faltas</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 8px;">Clique para ver
                                detalhes</div>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="calendar-grid"
                        style="background: white; padding: 16px; border-radius: 16px; border: 1px solid #e5e7eb;">
                        <div class="calendar-header">D</div>
                        <div class="calendar-header">S</div>
                        <div class="calendar-header">T</div>
                        <div class="calendar-header">Q</div>
                        <div class="calendar-header">Q</div>
                        <div class="calendar-header">S</div>
                        <div class="calendar-header">S</div>
                        <div id="calendarDays" style="display: contents;"></div>
                    </div>

                    <!-- Legend -->
                    <div
                        style="display: flex; gap: 20px; justify-content: center; margin-top: 20px; padding: 15px; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                            <div style="width: 16px; height: 16px; background: #10b981; border-radius: 4px;"></div>
                            Presente
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                            <div style="width: 16px; height: 16px; background: #ef4444; border-radius: 4px;"></div>
                            Ausente
                        </div>
                    </div>
                </div>

                <!-- GRADES TAB -->
                <div id="tabGradesContent" class="hidden">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label">Filho</label>
                        <select id="gradesStudentSelect" class="input" onchange="loadGrades(this.value)">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div id="gradesList">
                        <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                            Carregando notas...
                        </div>
                    </div>
                </div>

                <!-- REPORTS TAB -->
                <div id="tabReportsContent" class="hidden">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="label">Filho</label>
                        <select id="reportsStudentSelect" class="input" onchange="loadReports(this.value)">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div id="reportsList">
                        <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                            Carregando relat√≥rios...
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Notifications Screen -->
        <div id="notificationsScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Eventos</h1>
                <p class="header-subtitle">Passeios e Comunicados</p>
            </div>
            <div class="content">
                <div id="eventsList"></div>
                <div class="empty" id="eventsEmpty">
                    <div class="empty-icon">üìÖ</div>
                    <p class="empty-title">Nenhum aviso</p>
                    <p class="empty-text">A escola ainda n√£o publicou eventos.</p>
                </div>
            </div>
        </div>

        <!-- Messages Screen (List of Chats) -->
        <div id="messagesScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Mensagens</h1>
                <p class="header-subtitle">Converse com a escola</p>
            </div>
            <div class="content" style="padding: 40px 16px 20px 16px;">
                <div id="chatList">
                    <!-- Populated via JS -->
                </div>
                <div id="emptyChat" class="empty hidden">
                    <div class="empty-icon">üí¨</div>
                    <p class="empty-title">Nenhuma mensagem</p>
                </div>
            </div>
        </div>

        <!-- Chat Detail Screen -->
        <div id="chatScreen" class="hidden">
            <div class="header"
                style="position: sticky; top: 0; z-index: 100; display: flex; align-items: center; gap: 10px;">
                <button class="chat-btn-icon" style="color: white; font-size: 20px;" onclick="closeChat()">‚Üê</button>
                <div style="flex: 1;">
                    <h1 class="header-greeting" id="chatStudentName" style="font-size: 16px;">Aluno</h1>
                    <p class="header-subtitle" id="chatSchoolName">Escola</p>
                </div>
            </div>
            <div class="chat-screen-content">
                <div id="chatMessages" class="chat-messages">
                    <!-- Messages go here -->
                </div>
            </div>
            <div class="chat-input-bar">
                <button class="chat-btn-icon" onclick="document.getElementById('fileInput').click()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="#54656f">
                        <path
                            d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" />
                    </svg>
                </button>
                <input type="text" class="chat-input" id="messageInput" placeholder="Mensagem">
                <button class="chat-btn-icon" id="sendBtn" style="display: none;" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>

                <input type="file" id="fileInput" hidden onchange="handleFileSelect(this)">
            </div>
        </div>

        <!-- Financial Screen -->
        <div id="financialScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Pagamentos</h1>
                <p class="header-subtitle">Mensalidades e Taxas</p>
            </div>
            <div class="content">
                <div id="financialList">
                    <!-- Invoices will appear here -->
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        Carregando...
                    </div>
                </div>

                <div id="financialEmpty" class="hidden empty">
                    <div class="empty-icon">üí∏</div>
                    <p class="empty-title">Tudo em dia!</p>
                    <p class="empty-text">Nenhuma cobran√ßa pendente encontrada.</p>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden">
            <div class="header">
                <h1 class="header-greeting">Configura√ß√µes</h1>
                <p class="header-subtitle">Sua conta</p>
            </div>
            <div class="content">
                <div class="section-title">Dados da Conta</div>
                <div class="form-group">
                    <label class="label">Nome</label>
                    <input type="text" id="settingsName" class="input">
                </div>
                <div class="form-group">
                    <label class="label">Email</label>
                    <input type="email" id="settingsEmail" class="input" disabled>
                </div>
                <label class="label">Telefone</label>
                <input type="tel" id="settingsPhone" class="input">
            </div>
            <!-- API URL removed for security -->
            <button class="btn-primary" onclick="testNotification()"
                style="background-color: #f59e0b; margin-top: 10px;">üîî Testar Som/Notifica√ß√£o</button>
            <button class="btn-secondary" onclick="logout()" style="margin-top: 10px;">Sair</button>
        </div>
    </div>

    <script>
        function testNotification() {
            // Desbloquear audio context se necess√°rio
            if (window.audioCtxGlobal && window.audioCtxGlobal.state === 'suspended') {
                window.audioCtxGlobal.resume();
            }
            const mock = {
                id: Math.floor(Math.random() * 10000),
                school_name: 'Escola Exemplo',
                student_name: 'Seu Filho',
                event_type: 'arrival',
                timestamp: new Date().toISOString(),
                photo_url: null,
                class_name: 'Teste de Som'
            };
            showNotificationOverlay(mock);
        }

        function loadSettings() {
            // Carregar dados do respons√°vel logado
            if (user) {
                document.getElementById('settingsName').value = user.name || '';
                document.getElementById('settingsEmail').value = user.email || '';
                document.getElementById('settingsPhone').value = user.phone || '';
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                user = null;
                myStudentsData = [];
                stopNotificationPoller();
                showLogin();
            }
        }
    </script>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav hidden" id="bottomNav">
        <div class="nav-item active" onclick="navigate('home')">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">In√≠cio</div>
        </div>
        <div class="nav-item" onclick="navigate('academic')">
            <div class="nav-icon">üéì</div>
            <div class="nav-label">Acad√™mico</div>
        </div>
        <div class="nav-item" onclick="navigate('notifications')">
            <div class="nav-icon">üìÖ</div>
            <div class="nav-label">Eventos</div>
        </div>
        <div class="nav-item" onclick="navigate('financial')">
            <div class="nav-icon">üí≤</div>
            <div class="nav-label">Pagamentos</div>
        </div>
        <div class="nav-item" onclick="navigate('messages')" style="position: relative;">
            <div class="nav-icon">üí¨</div>
            <div class="nav-label">Mensagens</div>
            <div id="bottom-nav-badge" class="nav-badge" style="display: none;">0</div>
        </div>
        <div class="nav-item" onclick="navigate('settings')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div class="nav-label">Configura√ß√µes</div>
        </div>
    </div>
    <script>
        console.log('üöÄ Guardian App JavaScript carregado!');

        // Desbloquear AudioContext com intera√ß√£o do usu√°rio (obrigat√≥rio em navegadores modernos)
        window.audioCtxGlobal = null;
        document.addEventListener('click', () => {
            if (!window.audioCtxGlobal) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                window.audioCtxGlobal = new AudioContext();
            }
            if (window.audioCtxGlobal.state === 'suspended') {
                window.audioCtxGlobal.resume();
            }
        }, { once: false }); // Tenta desbloquear em qualquer clique
    </script>
    </div>

    <script>
        // API Local (Porta 5000)
        // API Logic
        const defaultApiUrl = window.location.hostname === 'localhost'
            ? 'http://localhost:5000/api'
            : `http://${window.location.hostname}:5000/api`;

        // Check for override
        const storedApiUrl = localStorage.getItem('custom_api_url');
        const API_URL = storedApiUrl || defaultApiUrl;

        function saveApiUrl() {
            const val = document.getElementById('settingsApiUrl').value;
            if (val) {
                localStorage.setItem('custom_api_url', val);
                alert('Endere√ßo do servidor atualizado! O app ser√° recarregado.');
                window.location.reload();
            }
        }

        let user = null;
        let selectedSchool = null;
        let selectedClass = null;
        let selectedStudent = null;
        let eventSource = null;
        let myStudentsData = [];
        let currentReportDate = new Date();
        let activeChatStudentId = null;
        let chatPollInterval = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentAttendanceData = [];

        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');

            if (token && userData) {
                try {
                    user = JSON.parse(userData);
                    navigate('home');
                    startNotificationPoller();
                } catch (e) {
                    showLogin();
                }
            } else {
                showLogin();
            }
        });

        // --- REAL-TIME: SERVER SENT EVENTS (Webhook Listening) ---
        function startNotificationListener() {
            if (eventSource && (eventSource.readyState === 0 || eventSource.readyState === 1)) return; // J√° conectado ou conectando

            const token = localStorage.getItem('token');
            if (!token) return;

            // Conectar ao endpoint SSE unificado
            const sseUrl = `${API_URL}/guardian/events?token=${token}`;
            console.log('üì° Conectando ao canal de notifica√ß√µes (SSE)...', sseUrl);

            eventSource = new EventSource(sseUrl);

            eventSource.onopen = () => console.log('‚úÖ Canal de Notifica√ß√µes Ativo (SSE)');

            eventSource.onmessage = (event) => {
                try {
                    // Ignorar heartbeat ou mensagens de controle se houver
                    if (!event.data || event.data.includes('"type":"connected"')) return;

                    const payload = JSON.parse(event.data);

                    if (payload.type === 'notification') {
                        console.log('üîî Notifica√ß√£o Recebida (SSE):', payload.data);
                        showNotificationOverlay(payload.data);
                        markAsRead(payload.data.id);
                    }
                } catch (e) {
                    // console.error('Erro ao processar evento SSE:', e);
                }
            };

            eventSource.onerror = (err) => {
                // console.log('‚ö†Ô∏è Conex√£o SSE inst√°vel...');
            };
        }

        function stopNotificationListener() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        // --- SISTEMA DE NOTIFICA√á√ÉO (POLLING - COMO ERA ANTES) ---
        let notificationPoller = null;

        function startNotificationPoller() {
            if (notificationPoller) return;
            console.log('üì° Iniciando Polling (2s)...');
            checkNotifications();
            notificationPoller = setInterval(checkNotifications, 2000);
        }

        function stopNotificationPoller() {
            if (notificationPoller) {
                clearInterval(notificationPoller);
                notificationPoller = null;
            }
        }

        let isFetching = false;
        async function checkNotifications() {
            if (isFetching) return;
            isFetching = true;

            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                // Check regular notifications (arrival/departure)
                const res = await fetch(`${API_URL}/guardian/check-notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Se token inv√°lido, for√ßar re-login
                if (res.status === 401 || res.status === 403) {
                    console.log('üîí Token inv√°lido detectado, for√ßando re-login...');
                    stopNotificationPoller();
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    user = null;
                    showLogin();
                    return;
                }

                if (res.ok) {
                    const data = await res.json();
                    // O servidor retorna { notification } com uma √∫nica notifica√ß√£o se houver
                    if (data.notification) {
                        showNotificationOverlay(data.notification);
                    }
                }

                // Check active pickups (when inspector calls the student - show on card)
                try {
                    const pickupRes = await fetch(`${API_URL}/guardian/active-pickups`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (pickupRes.ok) {
                        const activePickups = await pickupRes.json();

                        // Get all student IDs that are currently being called
                        const callingStudentIds = activePickups.map(p => p.student_id);

                        // Reset cards that are NOT being called anymore
                        document.querySelectorAll('.child-card-prof.calling-animation').forEach(card => {
                            const container = card.querySelector('[class*="pickup-container-"]');
                            if (container) {
                                const match = container.className.match(/pickup-container-(\d+)/);
                                if (match && !callingStudentIds.includes(parseInt(match[1]))) {
                                    card.classList.remove('calling-animation');
                                    card.dataset.notified = '';

                                    // Reset button to normal state
                                    const btn = document.getElementById(`pickup-btn-${match[1]}`);
                                    if (btn) {
                                        btn.style.background = '';
                                        btn.style.boxShadow = '';
                                        btn.disabled = false;
                                        btn.innerHTML = '‚úÖ Estou na Escola - Notificar Chegada!';
                                        btn.classList.remove('calling-btn-animation');
                                        btn.classList.remove('waiting-call-animation');
                                    }
                                }
                            }
                        });

                        // Activate calling animation for students being called
                        if (activePickups && activePickups.length > 0) {
                            activePickups.forEach(pickup => {
                                const card = document.querySelector(`.pickup-container-${pickup.student_id}`)?.closest('.child-card-prof');
                                const btn = document.getElementById(`pickup-btn-${pickup.student_id}`);
                                const remoteBtn = document.getElementById(`remote-btn-${pickup.student_id}`);

                                if (card) {
                                    card.classList.add('calling-animation');

                                    // Hide remote button
                                    if (remoteBtn) remoteBtn.style.display = 'none';

                                    // Hide distance info
                                    const distInfo = document.getElementById(`dist-info-${pickup.student_id}`);
                                    if (distInfo) distInfo.style.display = 'none';

                                    // Update button to show "SENDO CHAMADO!" - laranja puro, APENAS ISSO
                                    if (btn) {
                                        btn.disabled = true;
                                        btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                                        btn.style.boxShadow = '0 4px 25px rgba(245, 158, 11, 0.6)';
                                        btn.style.color = 'white';
                                        btn.style.border = '3px solid #fbbf24';
                                        btn.style.fontSize = '16px';
                                        btn.style.fontWeight = '800';
                                        btn.style.padding = '18px';
                                        btn.innerHTML = 'üì¢ ALUNO SENDO CHAMADO NA SALA!';
                                        btn.classList.remove('waiting-call-animation');
                                        btn.classList.add('calling-btn-animation');
                                    }

                                    // Play sound only if first time (no popup)
                                    if (!card.dataset.notified) {
                                        card.dataset.notified = 'true';
                                        playNotificationSound();
                                    }
                                }
                            });
                        }
                    }
                } catch (e) {
                    // Silencioso
                }
            } catch (error) {
                // Silencioso
            } finally {
                isFetching = false;
            }
        }

        // Notifica√ß√£o quando o inspetor chama o aluno
        function showPickupCallingNotification(notif) {
            // Se estiver em cooldown, ignora
            if (isCooldown) return;

            // Remover overlay anterior se existir
            const existingOverlay = document.getElementById('notification-overlay');
            if (existingOverlay) existingOverlay.remove();

            // Tela fullscreen
            const overlay = document.createElement('div');
            overlay.id = 'notification-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: linear-gradient(135deg, #1e3a5f 0%, #0c1929 100%);
                z-index: 99999;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
                font-family: 'Inter', sans-serif;
            `;

            overlay.innerHTML = `
                <div style="text-align: center; animation: pulse-scale 1s infinite alternate;">
                    <div style="font-size: 100px; margin-bottom: 20px;">üì¢</div>
                    <h1 style="font-size: 28px; font-weight: 900; color: #10b981; margin: 0 0 10px 0; text-transform: uppercase;">
                        Aluno Sendo Chamado!
                    </h1>
                    <h2 style="font-size: 36px; font-weight: 900; color: white; margin: 0 0 20px 0;">
                        ${notif.student_name || 'Seu filho(a)'}
                    </h2>
                    <p style="font-size: 18px; color: #94a3b8; margin: 0 0 30px 0;">
                        O inspetor est√° chamando na sala de aula.<br>
                        Aguarde na portaria!
                    </p>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        padding: 16px 40px;
                        font-size: 18px;
                        font-weight: 700;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        border: none;
                        border-radius: 16px;
                        cursor: pointer;
                        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
                    ">
                        ‚úÖ Entendido
                    </button>
                </div>
                <style>
                    @keyframes pulse-scale {
                        from { transform: scale(1); }
                        to { transform: scale(1.02); }
                    }
                </style>
            `;

            document.body.appendChild(overlay);

            // Tocar som de notifica√ß√£o
            playNotificationSound();

            // Ativa cooldown
            isCooldown = true;
            setTimeout(() => isCooldown = false, 10000);

            // Auto-remover ap√≥s 15 segundos
            setTimeout(() => {
                if (document.getElementById('notification-overlay')) {
                    overlay.remove();
                }
            }, 15000);
        }

        function playNotificationSound() {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, context.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(440, context.currentTime + 0.3);

                gainNode.gain.setValueAtTime(0.3, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.3);

                oscillator.connect(gainNode);
                gainNode.connect(context.destination);

                oscillator.start();
                oscillator.stop(context.currentTime + 0.3);
            } catch (e) {
                console.log('Audio n√£o suportado');
            }
        }




        let isCooldown = false; // Cooldown global para evitar spam sonoro

        function showNotificationOverlay(notif) {
            // Se estiver em cooldown, ignora
            if (isCooldown) {
                console.log('üîá Em cooldown de √°udio (10s), ignorando visualiza√ß√£o.');
                return;
            }

            // Remover overlay anterior se existir
            const existingOverlay = document.getElementById('notification-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }

            // Tela preta fullscreen
            const overlay = document.createElement('div');
            overlay.id = 'notification-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #000;
                z-index: 99999;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-between;
                padding: 4vh 5vw;
                box-sizing: border-box;
                font-family: 'Inter', sans-serif;
                overflow: hidden;
            `;

            const icon = notif.event_type === 'arrival' ? 'üëã' : 'üè†';
            const title = notif.event_type === 'arrival' ? 'CHEGOU NA ESCOLA' : 'SAIU DA ESCOLA';
            const color = notif.event_type === 'arrival' ? '#10b981' : '#f59e0b';
            const shadowRGB = notif.event_type === 'arrival' ? '16, 185, 129' : '245, 158, 11';
            const time = new Date(notif.timestamp).toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            const photoUrl = notif.photo_url || '';

            const duration = 10; // 10 Segundos

            overlay.innerHTML = `
                <!-- ESCOLA NO TOPO -->
                <div style="text-align: center; width: 100%; z-index: 10;">
                    <div style="font-size: 1.5vh; color: #888; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 1vh; font-weight: 300;">NOTIFICA√á√ÉO DE</div>
                    <h1 style="font-size: 3.5vh; font-weight: 900; color: white; margin: 0; text-transform: uppercase; line-height: 1.1; word-wrap: break-word; letter-spacing: 1px;">${notif.school_name || 'ESCOLA'}</h1>
                </div>

                <!-- FOTO CENTRAL COM EFEITO DE PULSO/GLOW -->
                <div style="
                    position: relative; 
                    width: 40vh; 
                    height: 40vh; 
                    max-width: 80vw; 
                    max-height: 80vw; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    margin: 4vh 0;
                ">
                    <!-- Camada de Anima√ß√£o de Pulso (Emanando) -->
                    <div style="
                        position: absolute;
                        top: 0; left: 0; right: 0; bottom: 0;
                        border-radius: 50%;
                        background: ${color};
                        z-index: 0;
                        animation: pulse-ring 3s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
                    "></div>
                    
                    <!-- Segunda Camada (Delay) -->
                    <div style="
                        position: absolute;
                        top: 0; left: 0; right: 0; bottom: 0;
                        border-radius: 50%;
                        background: ${color};
                        z-index: 0;
                        animation: pulse-ring 3s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
                        animation-delay: 1.5s;
                    "></div>

                    <!-- Foto do Aluno -->
                    <div style="
                        width: 100%;
                        height: 100%;
                        border-radius: 50%;
                        background: #1a1a1a;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10vh;
                        color: white;
                        font-weight: 700;
                        overflow: hidden;
                        position: relative;
                        z-index: 2;
                        border: 4px solid ${color};
                        animation: border-flash 1.5s infinite;
                    ">
                        ${photoUrl ? `<img src="${photoUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : notif.student_name.charAt(0).toUpperCase()}
                    </div>

                    <!-- √çcone de Status -->
                    <div style="
                        position: absolute;
                        bottom: 0;
                        right: 0;
                        width: 22%;
                        height: 22%;
                        background: ${color};
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 3.5vh;
                        z-index: 3;
                        border: 4px solid #000;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        animation: bounce 2s infinite;
                    ">
                        ${icon}
                    </div>
                </div>

                <!-- INFO INFERIOR -->
                <div style="text-align: center; width: 90%; z-index: 10;">
                    <h2 style="font-size: 4vh; font-weight: 800; color: white; margin: 0 0 1vh 0; text-transform: uppercase; line-height: 1.1; letter-spacing: 0.5px;">${notif.student_name}</h2>
                    
                    <!-- TURMA ADICIONADA -->
                    <div style="font-size: 2.5vh; color: rgba(255,255,255,0.7); margin-bottom: 2vh; font-weight: 500; text-transform: uppercase; letter-spacing: 1px;">
                       ${notif.className || notif.class_name || ''}
                    </div>

                    <div style="display: inline-flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); padding: 1.5vh 6vw; border-radius: 50px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); width: auto; max-width: 90%;">
                        <span style="font-size: 2vh; color: ${color}; font-weight: 700; text-transform: uppercase; margin-right: 15px; white-space: nowrap; letter-spacing: 1px;">${title}</span>
                        <span style="width: 1px; height: 2.5vh; background: rgba(255,255,255,0.2); margin-right: 15px;"></span>
                        <span style="font-size: 2.5vh; color: rgba(255,255,255,0.9); font-weight: 400; font-family: monospace;">${time}</span>
                    </div>
                </div>

                <style>
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
                    @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
                    
                    /* Efeito de Onda - Safe */
                    @keyframes pulse-ring {
                        0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(${shadowRGB}, 0.8); }
                        100% { transform: scale(2); opacity: 0; box-shadow: 0 0 100px 50px rgba(${shadowRGB}, 0); }
                    }
                    
                    /* Efeito de Flash na Borda da Foto */
                    @keyframes border-flash {
                        0%, 100% { border-color: ${color}; box-shadow: 0 0 30px rgba(${shadowRGB}, 0.5); }
                        50% { border-color: white; box-shadow: 0 0 60px rgba(${shadowRGB}, 1); }
                    }
                </style>
            `;

            document.body.appendChild(overlay);

            // Som: "Ding Dong" Moderno (Mais alto e claro)
            // Som: "Ding Dong" Moderno + Fala (TTS)
            const playSound = async () => {
                // 1. Tentar tocar o som (Oscilador)
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const audioCtx = window.audioCtxGlobal || new AudioContext(); // Tenta global ou cria novo

                    if (audioCtx.state === 'suspended') {
                        await audioCtx.resume().catch(() => console.log('√Åudio autoplay bloqueado'));
                    }

                    const playBell = (freq, startTime, duration) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.type = 'triangle'; // Timbre mais met√°lico (sino)

                        osc.frequency.setValueAtTime(freq, startTime);

                        // Envelope percussivo de sino
                        gain.gain.setValueAtTime(0, startTime);
                        gain.gain.linearRampToValueAtTime(0.6, startTime + 0.05); // Ataque r√°pido mas suave
                        gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration); // Decay longo

                        osc.connect(gain);
                        gain.connect(audioCtx.destination);

                        osc.start(startTime);
                        osc.stop(startTime + duration);
                    };

                    const now = audioCtx.currentTime;
                    // Ding (Mi 5 - ~660Hz)
                    playBell(660, now, 1.5);
                    // Dong (D√≥ 5 - ~523Hz) - Mais grave e longo
                    playBell(523, now + 0.5, 2.0);
                } catch (e) {
                    console.error("Erro no som digital:", e);
                }

                // 2. FALA (Text-to-Speech) - Backup robusto que funciona em muitos bloqueios
                if ('speechSynthesis' in window) {
                    try {
                        const msg = new SpeechSynthesisUtterance();
                        // Texto din√¢mico
                        const acao = notif.event_type === 'arrival' ? 'chegou na escola' : 'saiu da escola';
                        // msg.text = `EduFocus informa: ${notif.student_name} ${acao}.`;
                        // Alterado para falar em nome da escola
                        const schoolName = notif.school_name || 'A escola';
                        msg.text = `${schoolName} informa: ${notif.student_name} ${acao}.`;
                        msg.lang = 'pt-BR';
                        msg.volume = 1;
                        msg.rate = 1.1; // Um pouco mais r√°pido e natural
                        msg.pitch = 1.0;
                        window.speechSynthesis.speak(msg);
                    } catch (e) {
                        console.error("Erro na fala:", e);
                    }
                }

                // 3. Vibra√ß√£o
                if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            };
            playSound();

            // --- NOVO: VIBRA√á√ÉO E WAKE LOCK ---

            // 1. Vibrar (Padr√£o: Longo, Curto, Longo)
            if ('vibrate' in navigator) {
                try { navigator.vibrate([1000, 300, 1000, 300, 1000]); } catch (e) { }
            }

            // 2. Acordar a Tela (Wake Lock API)
            try {
                if ('wakeLock' in navigator) {
                    navigator.wakeLock.request('screen')
                        .then(lock => {
                            console.log('üí° Tela mantida acesa por Wake Lock');
                            // Soltar ap√≥s 15s (um pouco mais que a notifica√ß√£o)
                            setTimeout(() => lock.release(), 15000);
                        })
                        .catch(err => console.log('Wake Lock bloqueado:', err));
                }
            } catch (e) { }

            // 3. Disparar Notifica√ß√£o de Sistema (Ajuda a ligar a tela no Android)
            if (Notification.permission === 'granted' && document.hidden) {
                try {
                    const natif = new Notification(title, {
                        body: `${notif.student_name} - ${notif.school_name}`,
                        icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png', // Icone generico escolar
                        tag: 'school-alert',
                        vibrate: [1000, 300, 1000]
                    });
                    natif.onclick = () => {
                        window.focus();
                        natif.close();
                    };
                } catch (e) { }
            }

            // REMOVER AP√ìS 10 SEGUNDOS
            setTimeout(() => {
                overlay.style.animation = 'fadeOut 1s ease-out forwards'; // Sa√≠da mais lenta

                isCooldown = true;

                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.remove();
                    }
                }, 1000);

                setTimeout(() => { isCooldown = false; }, 10000);

            }, duration * 1000);
        }

        // Solicitar permiss√£o ao iniciar
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        }

        // Chamar ao carregar ou logar
        setTimeout(requestNotificationPermission, 2000);

        async function markAsRead(notificationId) {
            try {
                const token = localStorage.getItem('token');
                await fetch(`${API_URL}/guardian/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) { console.error('Erro ao marcar como lida:', error); }
        }

        // Vari√°vel global para o intervalo de polling
        let eventsPollingInterval = null;

        function navigate(page) {
            // Limpar polling se n√£o estiver na tela de eventos
            if (eventsPollingInterval) {
                console.log('üîÑ Parando Polling anterior...');
                clearInterval(eventsPollingInterval);
                eventsPollingInterval = null;
            }
            // Ocultar todas as telas
            const screens = ['loginScreen', 'registerScreen', 'homeScreen', 'linkScreen', 'academicScreen', 'notificationsScreen', 'messagesScreen', 'settingsScreen', 'chatScreen', 'financialScreen', 'reportsScreen'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // Gerenciar menu inferior
            const bottomNav = document.getElementById('bottomNav');
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            // Navega√ß√£o
            if (page === 'home') {
                document.getElementById('homeScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                if (navItems[0]) navItems[0].classList.add('active');
                loadChildren();
            }
            else if (page === 'academic' || page === 'reports') {
                document.getElementById('academicScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                if (navItems[1]) navItems[1].classList.add('active');
                // Load default tab: Attendance
                switchAcademicTab('attendance');
            }
            else if (page === 'notifications') {
                document.getElementById('notificationsScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                if (navItems[2]) navItems[2].classList.add('active');
                if (typeof loadEventsAndNotifications === 'function') loadEventsAndNotifications();
                startEventsSSE();
            }
            else if (page === 'financial') {
                document.getElementById('financialScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                if (navItems[3]) navItems[3].classList.add('active');
                loadFinancial();
            }
            else if (page === 'messages') {
                document.getElementById('messagesScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                if (navItems[4]) navItems[4].classList.add('active');
                loadChatList();
            }
            else if (page === 'settings') {
                document.getElementById('settingsScreen').classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                if (navItems[5]) navItems[5].classList.add('active');
                if (typeof loadSettings === 'function') loadSettings();
            }
            else if (page === 'link') {
                document.getElementById('linkScreen').classList.remove('hidden');
                bottomNav.classList.add('hidden');
                if (typeof resetLink === 'function') resetLink();
            }
        }

        async function loadFinancial() {
            const listDiv = document.getElementById('financialList');
            const emptyDiv = document.getElementById('financialEmpty');

            listDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Carregando cobran√ßas...</div>';
            emptyDiv.classList.add('hidden');

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/invoices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Erro ao buscar faturas');

                const data = await res.json();
                const invoices = data.invoices || [];

                if (invoices.length === 0) {
                    listDiv.innerHTML = '';
                    emptyDiv.classList.remove('hidden');
                    return;
                }

                renderInvoices(invoices);
            } catch (e) {
                console.error(e);
                listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#ef4444;">Erro ao carregar pagamentos.</div>';
            }
        }

        function renderInvoices(invoices) {
            const listDiv = document.getElementById('financialList');

            // Mapeamento de Status
            const statusMap = {
                'pending': { label: 'Pendente', color: '#f59e0b', bg: '#fef3c7' },
                'paid': { label: 'Pago', color: '#10b981', bg: '#ecfdf5' },
                'overdue': { label: 'Vencido', color: '#ef4444', bg: '#fee2e2' },
                'cancelled': { label: 'Cancelado', color: '#9ca3af', bg: '#f3f4f6' }
            };

            listDiv.innerHTML = invoices.map(inv => {
                const st = statusMap[inv.status] || statusMap['pending'];
                const dueDate = new Date(inv.due_date);
                const isOverdue = inv.status === 'pending' && new Date() > dueDate;

                const finalStatus = isOverdue ? statusMap['overdue'] : st;

                return `
                    <div class="event-card" style="border-left: 4px solid ${finalStatus.color};">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span style="font-size:12px; color:#6b7280; text-transform:uppercase; font-weight:600;">Due: ${dueDate.toLocaleDateString('pt-BR')}</span>
                            <span style="background:${finalStatus.bg}; color:${finalStatus.color}; padding:2px 8px; border-radius:12px; font-size:11px; font-weight:700;">${finalStatus.label}</span>
                        </div>
                        
                        <h3 style="font-size:16px; font-weight:700; color:#111827; margin-bottom:4px;">${inv.description}</h3>
                        <div style="font-size:13px; color:#6b7280; margin-bottom:12px;">${inv.student_name} ‚Ä¢ ${inv.school_name}</div>
                        
                        <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #f3f4f6; padding-top:12px;">
                            <span style="font-size:18px; font-weight:700; color:#111827;">R$ ${parseFloat(inv.amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                            
                            ${inv.payment_url && inv.status === 'pending' ? `
                                <a href="${inv.payment_url}" target="_blank" 
                                   style="background:#6366f1; color:white; text-decoration:none; padding:8px 16px; border-radius:8px; font-size:13px; font-weight:600;">
                                   Pagar Agora
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- LOAD CHILDREN (Home Screen) ---
        async function loadChildren() {
            const childrenList = document.getElementById('childrenList');
            if (!childrenList) return;

            childrenList.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Carregando seus filhos...</div>';

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/my-students`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Erro ao buscar alunos');

                const data = await res.json();
                myStudentsData = data.students || [];

                if (myStudentsData.length === 0) {
                    childrenList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 8px;">Nenhum filho vinculado</h3>
                            <p style="font-size: 14px; color: #6b7280;">Entre em contato com a escola para vincular seus filhos.</p>
                        </div>
                    `;
                    return;
                }

                // Renderizar lista de filhos
                childrenList.innerHTML = myStudentsData.map(student => `
                    <div class="child-card" style="cursor: pointer;" onclick="viewStudentDetails(${student.id}, ${student.school_id})">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #8b5cf6); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700;">
                                ${student.name.charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 4px;">${student.name}</div>
                                <div style="font-size: 13px; color: #6b7280;">${student.class_name || 'Sem turma'}</div>
                                <div style="font-size: 12px; color: #9ca3af; margin-top: 2px;">üìç ${student.school_name}</div>
                            </div>
                            <div style="color: #6366f1; font-size: 20px;">‚Üí</div>
                        </div>
                    </div>
                `).join('');

                console.log('‚úÖ Carregados', myStudentsData.length, 'alunos com localiza√ß√£o da escola');

            } catch (e) {
                console.error('Erro ao carregar filhos:', e);
                childrenList.innerHTML = '<div style="text-align:center; padding:20px; color:#ef4444;">Erro ao carregar dados.</div>';
            }
        }

        function viewStudentDetails(studentId, schoolId) {
            const student = myStudentsData.find(s => s.id === studentId && s.school_id === schoolId);
            if (!student) return;

            alert(`
Aluno: ${student.name}
Turma: ${student.class_name || 'N√£o definida'}
Escola: ${student.school_name}
Endere√ßo: ${student.school_address || ''} ${student.school_number || ''}
CEP: ${student.school_zip_code || ''}
GPS: ${student.school_latitude}, ${student.school_longitude}
            `);
        }





        // --- ACADEMIC ---
        // currentReportDate variable is already declared globally at line 1448
        // currentReportDate = new Date(); -- Do not reset here if we want to keep state across tab switches, or do reset? 
        // Let's reset it to be safe, but without 'let'
        currentReportDate = new Date();
        // let currentAttendanceData = []; -- This was fine if not declared before, but cleaner to declare it near usage or global.


        function switchAcademicTab(tab) {
            // Update Tab Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (tab === 'attendance') document.getElementById('tabBtnAttendance').classList.add('active');
            if (tab === 'grades') document.getElementById('tabBtnGrades').classList.add('active');
            if (tab === 'reports') document.getElementById('tabBtnReports').classList.add('active');

            // Hide all contents
            document.getElementById('tabAttendanceContent').classList.add('hidden');
            document.getElementById('tabGradesContent').classList.add('hidden');
            document.getElementById('tabReportsContent').classList.add('hidden');

            // Show selected
            if (tab === 'attendance') {
                document.getElementById('tabAttendanceContent').classList.remove('hidden');
                populateAcademicSelects();
                // Force load if student selected
                const sel = document.getElementById('reportStudentSelect');
                if (sel) {
                    if (!sel.value && myStudentsData.length > 0) sel.value = myStudentsData[0].id;
                    if (sel.value) loadReportStudent(sel.value);
                }
            } else if (tab === 'grades') {
                document.getElementById('tabGradesContent').classList.remove('hidden');
                populateAcademicSelects();
            } else if (tab === 'reports') {
                document.getElementById('tabReportsContent').classList.remove('hidden');
                populateAcademicSelects();
            }
        }

        function populateAcademicSelects() {
            // Populate select boxes if they are empty
            const selects = ['reportStudentSelect', 'gradesStudentSelect', 'reportsStudentSelect'];

            selects.forEach(id => {
                const el = document.getElementById(id);
                // Populate if empty
                if (el && el.options.length <= 1 && myStudentsData.length > 0) {
                    myStudentsData.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        el.appendChild(opt);
                    });
                }

                // FORCE selection if nothing selected and data exists
                if (el && !el.value && myStudentsData.length > 0) {
                    el.value = myStudentsData[0].id;
                    el.dispatchEvent(new Event('change'));
                }
            });
        }

        async function loadReportStudent(studentId) {
            if (!studentId) return;

            // Validate student
            const student = myStudentsData.find(s => s.id == studentId);
            if (!student) return;

            // Update Labels
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
                "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
            ];
            document.getElementById('reportMonthLabel').textContent = monthNames[currentReportDate.getMonth()];
            document.getElementById('reportYearLabel').textContent = currentReportDate.getFullYear();

            // Fetch Data
            const month = currentReportDate.getMonth() + 1;
            const year = currentReportDate.getFullYear();
            const schoolId = student.schoolId || student.school_id;

            try {
                const token = localStorage.getItem('token');
                const url = `${API_URL}/guardian/student-attendance?schoolId=${schoolId}&studentId=${studentId}&month=${month}&year=${year}`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json(); // Array of {timestamp, type}

                currentAttendanceData = data || [];
                renderCalendar();
                renderCalendar();
                // updateStats(); // Removed: renderCalendar already updates stats correctly

            } catch (e) {
                console.error("Erro ao carregar frequencia:", e);
                currentAttendanceData = [];
                renderCalendar();
            }
        }

        function changeReportMonth(delta) {
            currentReportDate.setMonth(currentReportDate.getMonth() + delta);
            const sel = document.getElementById('reportStudentSelect');
            if (sel && sel.value) loadReportStudent(sel.value);
        }

        function renderCalendar() {
            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            const year = currentReportDate.getFullYear();
            const month = currentReportDate.getMonth();

            const firstDay = new Date(year, month, 1).getDay(); // 0 = Sunday
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Empty slots for previous month
            for (let i = 0; i < firstDay; i++) {
                container.innerHTML += `<div class="calendar-day day-empty"></div>`;
            }

            // Count for stat cards
            let presenceCount = 0;
            let absenceCount = 0;
            window.lastPresenceDays = [];
            window.lastAbsenceDays = [];

            // Days
            const today = new Date();
            for (let d = 1; d <= daysInMonth; d++) {
                const checkDate = new Date(year, month, d);
                const yyyy = year;
                const mm = String(month + 1).padStart(2, '0');
                const dd = String(d).padStart(2, '0');
                const dateStr = `${yyyy}-${mm}-${dd}`;

                const records = currentAttendanceData.filter(r => r.timestamp.startsWith(dateStr));

                const isWeekend = (checkDate.getDay() === 0 || checkDate.getDay() === 6);
                const isFuture = checkDate > today;
                const isPresent = records.length > 0;

                let bgColor = '';
                let textColor = '';
                let className = '';

                if (!isFuture && !isWeekend) {
                    if (isPresent) {
                        bgColor = '#10b981';
                        textColor = 'white';
                        className = 'day-present';
                        presenceCount++;
                        window.lastPresenceDays.push(d);
                    } else {
                        bgColor = '#ef4444';
                        textColor = 'white';
                        className = 'day-absent';
                        absenceCount++;
                        window.lastAbsenceDays.push(d);
                    }
                } else if (isFuture) {
                    bgColor = '#f3f4f6';
                    textColor = '#9ca3af';
                } else {
                    // Weekend
                    bgColor = '#f9fafb';
                    textColor = '#d1d5db';
                }

                container.innerHTML += `
                    <div class="calendar-day ${className}" style="background: ${bgColor}; color: ${textColor}; font-weight: 600;">
                        ${d}
                    </div>
                `;
            }

            // Update stat cards
            const presenceEl = document.getElementById('presenceCount');
            const absenceEl = document.getElementById('absenceCount');
            if (presenceEl) presenceEl.textContent = presenceCount;
            if (absenceEl) absenceEl.textContent = absenceCount;
        }

        function updateStats() {
            // Count unique days present in this month view
            // Actually API returns records for this month. 
            // We count distinct days with 'arrival'
            const presentDays = new Set();
            currentAttendanceData.forEach(r => {
                if (r.type === 'arrival') {
                    // Robusto para 'T' ou espa√ßo
                    const datePart = r.timestamp.replace('T', ' ').split(' ')[0];
                    presentDays.add(datePart);
                }
            });

            const presentCount = presentDays.size;

            // Absent logic is tricky without knowing school days. 
            // For now, count weekdays in past/today up to now minus present.
            // Or just use 0 if we don't want to guess. 
            // Better: Count days in the past (weekdays) that are NOT in presentDays.

            let absentCount = 0;
            const year = currentReportDate.getFullYear();
            const month = currentReportDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for (let d = 1; d <= daysInMonth; d++) {
                const dt = new Date(year, month, d);
                if (dt > today) break;
                if (dt.getDay() === 0 || dt.getDay() === 6) continue; // Skip weekend

                const yyyy = year;
                const mm = String(month + 1).padStart(2, '0');
                const dd = String(d).padStart(2, '0');
                const dateStr = `${yyyy}-${mm}-${dd}`;

                if (!presentDays.has(dateStr)) {
                    absentCount++;
                }
            }

            const elPresent = document.getElementById('statPresent');
            if (elPresent) elPresent.textContent = presentCount;

            const elAbsent = document.getElementById('statAbsent');
            if (elAbsent) elAbsent.textContent = absentCount;
        }

        // Modal para mostrar calend√°rio completo
        function showAttendanceModal(type) {
            const monthLabel = document.getElementById('reportMonthLabel').textContent;
            const yearLabel = document.getElementById('reportYearLabel').textContent;
            const isPresent = type === 'present';
            const days = isPresent ? (window.lastPresenceDays || []) : (window.lastAbsenceDays || []);
            const bgColor = isPresent ? '#10b981' : '#ef4444';
            const title = isPresent ? '‚úÖ Dias de Presen√ßa' : '‚ùå Dias de Falta';
            const emoji = isPresent ? '‚úÖ' : '‚ùå';

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'attendance-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); z-index: 99999;
                display: flex; align-items: center; justify-content: center;
                padding: 20px; animation: fadeIn 0.2s ease;
            `;

            // Build days list with calendar grid
            let calendarHTML = '';
            if (days.length === 0) {
                calendarHTML = `<p style="text-align: center; color: #6b7280; padding: 20px;">Nenhum registro encontrado</p>`;
            } else {
                calendarHTML = `
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 10px;">
                        ${days.map(day => `
                            <div style="
                                width: 48px; height: 48px;
                                background: ${bgColor};
                                color: white;
                                border-radius: 12px;
                                display: flex; align-items: center; justify-content: center;
                                font-size: 18px; font-weight: 700;
                                box-shadow: 0 2px 8px ${isPresent ? 'rgba(16,185,129,0.4)' : 'rgba(239,68,68,0.4)'};
                            ">${day}</div>
                        `).join('')}
                    </div>
                `;
            }

            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 24px; width: 100%; max-width: 400px;
                    max-height: 80vh; overflow: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
                ">
                    <div style="
                        background: ${bgColor}; padding: 24px; border-radius: 24px 24px 0 0;
                        text-align: center;
                    ">
                        <div style="font-size: 48px; margin-bottom: 8px;">${emoji}</div>
                        <h2 style="color: white; font-size: 20px; font-weight: 800; margin: 0;">${title}</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin: 8px 0 0 0;">
                            ${monthLabel} ${yearLabel}
                        </p>
                    </div>
                    <div style="padding: 20px;">
                        <p style="text-align: center; color: #374151; font-weight: 600; margin-bottom: 16px;">
                            ${days.length} ${days.length === 1 ? 'dia' : 'dias'} registrado${days.length === 1 ? '' : 's'}
                        </p>
                        ${calendarHTML}
                    </div>
                    <div style="padding: 20px; border-top: 1px solid #e5e7eb;">
                        <button onclick="document.getElementById('attendance-modal').remove()"
                            style="
                                width: 100%; padding: 16px; background: ${bgColor}; color: white;
                                border: none; border-radius: 12px; font-size: 16px; font-weight: 700;
                                cursor: pointer; box-shadow: 0 4px 15px ${isPresent ? 'rgba(16,185,129,0.4)' : 'rgba(239,68,68,0.4)'};
                            ">
                            Fechar
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }

        async function loadGrades(studentId) {
            if (!studentId) return;
            const div = document.getElementById('gradesList');
            div.innerHTML = '<div style="text-align:center; padding:20px;">Carregando...</div>';

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/grades`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                // Filter by studentId locally since API returns all (or update API to filter)
                // The API returns all for the guardian. We filter here.
                const relevant = (data.grades || []).filter(g => g.student_id == studentId);

                if (relevant.length === 0) {
                    div.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">Nenhuma nota lan√ßada.</div>';
                    return;
                }

                div.innerHTML = relevant.map(g => `
                    <div style="background:var(--surface); padding:16px; border-radius:12px; margin-bottom:10px; border:1px solid var(--border); box-shadow:var(--shadow);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:700; color:var(--text-main);">${g.subject}</span>
                            <span style="background:${g.value >= 6 ? '#dcfce7' : '#fee2e2'}; color:${g.value >= 6 ? '#166534' : '#991b1b'}; padding:2px 8px; border-radius:12px; font-weight:700; font-size:14px;">${g.value}</span>
                        </div>
                        <div style="font-size:12px; color:var(--text-secondary);">
                            ${g.term} ‚Ä¢ ${g.teacher_name || 'Professor'} ‚Ä¢ ${new Date(g.created_at).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error(e);
                div.innerHTML = 'Erro ao carregar notas.';
            }
        }

        async function loadReports(studentId) {
            if (!studentId) return;
            const div = document.getElementById('reportsList');
            div.innerHTML = '<div style="text-align:center; padding:20px;">Carregando...</div>';

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/reports`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const relevant = (data.reports || []).filter(r => r.student_id == studentId);

                if (relevant.length === 0) {
                    div.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">Nenhum relat√≥rio encontrado.</div>';
                    return;
                }

                div.innerHTML = relevant.map(r => `
                     <div style="background:var(--surface); padding:16px; border-radius:12px; margin-bottom:10px; border:1px solid var(--border); box-shadow:var(--shadow);">
                        <div style="font-weight:700; color:var(--text-main); margin-bottom:5px;">${r.title}</div>
                        <div style="font-size:14px; color:var(--text-secondary); margin-bottom:10px; line-height:1.5;">${r.content}</div>
                        <div style="font-size:11px; color:#94a3b8; border-top:1px solid var(--border); padding-top:8px;">
                           ${r.teacher_name || 'Coordena√ß√£o'} ‚Ä¢ ${new Date(r.created_at).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                div.innerHTML = 'Erro ao carregar relat√≥rios.';
            }
        }

        function showLogin() {
            const screens = ['loginScreen', 'registerScreen', 'homeScreen', 'linkScreen', 'academicScreen', 'notificationsScreen', 'messagesScreen', 'settingsScreen', 'chatScreen', 'financialScreen', 'reportsScreen'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('bottomNav').classList.add('hidden');
        }

        function showRegister() {
            const screens = ['loginScreen', 'registerScreen', 'homeScreen', 'linkScreen', 'academicScreen', 'notificationsScreen', 'messagesScreen', 'settingsScreen', 'chatScreen', 'financialScreen', 'reportsScreen'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        function resetLink() {
            selectedSchool = null;
            selectedClass = null;
            selectedStudent = null;

            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.add('hidden');

            document.getElementById('schoolInput').value = '';
            document.getElementById('schoolResults').innerHTML = '';

            updateStep(1);
        }

        function updateStep(step) {
            const titles = ['Escola', 'Turma', 'Filho', 'Confirmar'];
            document.getElementById('stepTitle').textContent = `Passo ${step}: ${titles[step - 1]}`;

            for (let i = 1; i <= 4; i++) {
                document.getElementById(`bar${i}`).classList.toggle('active', i <= step);
            }
        }

        let schoolTimeout;
        async function searchSchools() {
            const query = document.getElementById('schoolInput').value.trim();

            if (query.length < 3) {
                document.getElementById('schoolResults').innerHTML = '';
                return;
            }

            clearTimeout(schoolTimeout);
            schoolTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`${API_URL}/guardian/schools?search=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    const schools = data; // O servidor retorna o array diretamente

                    const div = document.getElementById('schoolResults');

                    if (schools.length === 0) {
                        div.innerHTML = '<div class="result-item">Nenhuma escola encontrada</div>';
                    } else {
                        div.innerHTML = schools.map(s => `
                            <div class="result-item" onclick="selectSchool(${s.id}, '${s.name}')">
                                üè´ ${s.name}
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                }
            }, 300);
        }

        async function selectSchool(id, name) {
            selectedSchool = { id, name };
            document.getElementById('schoolInput').value = name;
            document.getElementById('schoolResults').innerHTML = '';

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            updateStep(2);

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/schools/${id}/classes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                // Servidor retorna array direto
                const classes = await res.json();
                const div = document.getElementById('classResults');

                if (classes.length === 0) {
                    div.innerHTML = '<div class="result-item">Nenhuma turma encontrada</div>';
                } else {
                    div.innerHTML = classes.map(c => `
                        <div class="result-item" onclick="selectClass('${c.name}')">
                            üìö ${c.name}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        function selectClass(name) {
            selectedClass = name;

            document.querySelectorAll('#classResults .result-item').forEach(item => {
                item.classList.toggle('selected', item.textContent.includes(name));
            });

            setTimeout(() => {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                updateStep(3);
            }, 300);
        }

        let studentTimeout;
        async function searchStudent() {
            const query = document.getElementById('studentInput').value.trim();
            const resultsDiv = document.getElementById('studentResults');

            if (query.length < 2) {
                if (resultsDiv) resultsDiv.innerHTML = '';
                return;
            }

            clearTimeout(studentTimeout);
            studentTimeout = setTimeout(async () => {
                try {
                    const token = localStorage.getItem('token');
                    // Busca aluno na turma selecionada (endpoint autenticado)
                    const url = `${API_URL}/guardian/schools/${selectedSchool.id}/students/search?name=${encodeURIComponent(query)}&className=${encodeURIComponent(selectedClass)}`;
                    const res = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const students = await res.json();

                    if (!resultsDiv) return;

                    if (students.length === 0) {
                        resultsDiv.innerHTML = '<div class="result-item" style="color: #999;">Nenhum aluno encontrado</div>';
                    } else {
                        resultsDiv.innerHTML = students.map(s => `
                            <div class="result-item" onclick="selectStudent(${JSON.stringify(s).replace(/"/g, '&quot;')})">
                                üë§ ${s.name}
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Erro na busca:', error);
                }
            }, 300);
        }

        function selectStudent(student) {
            selectedStudent = student;

            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
            updateStep(4);

            const photoDiv = document.getElementById('previewPhoto');
            if (selectedStudent.photo_url) {
                photoDiv.innerHTML = `<img src="${selectedStudent.photo_url}">`;
            } else {
                photoDiv.textContent = selectedStudent.name.charAt(0).toUpperCase();
            }

            document.getElementById('previewName').textContent = selectedStudent.name;
            document.getElementById('previewDetails').textContent = `${selectedClass} ‚Ä¢ ${selectedSchool.name}`;
        }


        async function confirmLink() {
            const errorDiv = document.getElementById('linkError');
            const successDiv = document.getElementById('linkSuccess');
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            const token = localStorage.getItem('token');

            // Verificar se est√° logado
            if (!token || !user) {
                errorDiv.textContent = '‚ùå Voc√™ precisa fazer login primeiro para vincular um filho.';
                errorDiv.classList.remove('hidden');
                setTimeout(() => {
                    showLogin();
                }, 2000);
                return;
            }

            try {
                const res = await fetch(`${API_URL}/guardian/link-student`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        school_id: selectedSchool.id,
                        student_id: selectedStudent.id
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        user = null;
                        errorDiv.textContent = '‚ùå Sess√£o expirada. Fa√ßa login novamente.';
                        errorDiv.classList.remove('hidden');
                        setTimeout(() => showLogin(), 2000);
                        return;
                    }

                    // Tentar ler a mensagem de erro do JSON
                    const errorData = data;
                    const errorMessage = errorData.error || errorData.message || 'Erro desconhecido ao vincular';

                    errorDiv.innerHTML = `‚ùå Erro: ${errorMessage}<br><small>Tente novamente ou contate a escola.</small>`;
                    errorDiv.classList.remove('hidden');
                    throw new Error(errorMessage);
                }

                successDiv.textContent = `‚úÖ ${selectedStudent.name} vinculado com sucesso!`;
                successDiv.classList.remove('hidden');

                setTimeout(() => {
                    navigate('home');
                }, 2000);
            } catch (error) {
                errorDiv.textContent = `‚ùå ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        }


        async function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const password = document.getElementById('regPassword').value;

            const errorDiv = document.getElementById('registerError');
            const successDiv = document.getElementById('registerSuccess');
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            if (!name || !email || !password) {
                errorDiv.textContent = '‚ùå Preencha todos os campos';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/guardian/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, phone, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Erro ao cadastrar');
                }

                successDiv.textContent = '‚úÖ Conta criada!';
                successDiv.classList.remove('hidden');

                setTimeout(() => showLogin(), 2000);
            } catch (error) {
                errorDiv.textContent = `‚ùå ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.add('hidden');

            if (!email || !password) {
                errorDiv.textContent = '‚ùå Preencha todos os campos';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/guardian/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Credenciais inv√°lidas');
                }

                const token = data.data?.token || data.token;
                const userData = data.data?.guardian || data.user;

                if (!token || !userData) {
                    throw new Error('Resposta inv√°lida');
                }

                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(userData));
                user = userData;

                navigate('home');
            } catch (error) {
                errorDiv.textContent = `‚ùå ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        function logout() {
            stopNotificationPoller();
            localStorage.clear();
            user = null;
            showLogin();
        }

        async function loadChildren(silent = false) {
            const div = document.getElementById('childrenList');
            if (!silent) div.innerHTML = '<div style="text-align: center; padding: 20px;">Carregando...</div>';

            try {
                const token = localStorage.getItem('token');
                // Corre√ß√£o: Endpoint correto '/my-students' e tratamento robusto da resposta
                const res = await fetch(`${API_URL}/guardian/my-students`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                const children = Array.isArray(data) ? data : (data.students || data.data?.students || []);

                // PERFORMANCE: S√≥ re-renderiza se os dados mudarem de fato
                const dataHash = JSON.stringify(children);
                if (silent && div.dataset.lastHash === dataHash) {
                    return;
                }
                div.dataset.lastHash = dataHash;

                myStudentsData = children;

                if (user) {
                    document.getElementById('greeting').textContent = `Ol√°, ${user.name.split(' ')[0]}!`;
                }

                if (!children || children.length === 0) {
                    div.innerHTML = `
                        <div class="empty">
                            <div class="empty-icon">üë∂</div>
                            <p class="empty-title">Nenhum filho vinculado</p>
                            <p class="empty-text">Clique abaixo para vincular</p>
                        </div>
                    `;
                    return;
                }

                div.innerHTML = children.map(child => {
                    const hasCoords = child.school_latitude && child.school_longitude;
                    const unreadCount = child.unread_messages || 0;
                    const badgeHtml = unreadCount > 0
                        ? `<div style="position:absolute; top:-8px; right:-8px; background:#ef4444; color:white; width:20px; height:20px; border-radius:50%; font-size:11px; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.2); animation: pulse 2s infinite;">${unreadCount}</div>`
                        : '';

                    return `
                        <div class="child-card-prof">
                            <div class="child-card-header">
                                <div class="child-avatar-prof">
                                    ${child.photo_url ? `<img src="${child.photo_url}" alt="${child.name}">` : child.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="child-info-prof">
                                    <div class="child-name-prof">${child.name}</div>
                                    <div class="child-details-prof">${child.class_name || 'Sem turma'} ‚Ä¢ ${child.school_name || ''}</div>
                                </div>
                                <button class="btn-msg-prof" style="position: relative;" onclick="openChatWithStudent(${child.id}, '${child.name}', '${child.school_id}', '${child.school_name}')" title="Mensagem">
                                    üí¨
                                    ${badgeHtml}
                                </button>
                            </div>
                            
                            <div class="pickup-container-${child.id}" style="margin-top: 16px;">
                                <div id="dist-info-${child.id}" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 6px; background: var(--bg-body); padding: 8px; border-radius: 8px;">
                                    ${hasCoords ? '<span>üìç Calculando dist√¢ncia...</span>' : '<span style="color: #9ca3af;">üìç Localiza√ß√£o da escola n√£o configurada</span>'}
                                </div>
                                
                                <div style="display: flex; gap: 8px; flex-direction: column;">
                                    <button id="pickup-btn-${child.id}" 
                                            class="btn-pickup" 
                                            onclick="requestPickup(${child.id}, ${child.school_id})"
                                            disabled>
                                        <span class="btn-icon">‚úÖ</span> Estou na Escola - Notificar Chegada!
                                    </button>
                                    
                                    <button id="remote-btn-${child.id}" 
                                            class="btn-remote-pickup hidden" 
                                            onclick="requestRemotePickup(${child.id}, ${child.school_id}, '${child.name.replace(/'/g, "\\'")}')">
                                        ‚ö†Ô∏è Autorizar Terceiro
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Atualizar Badge Inferior (Total de mensagens n√£o lidas de todos os filhos)
                const totalUnread = children.reduce((sum, child) => sum + (child.unread_messages || 0), 0);
                const bottomBadge = document.getElementById('bottom-nav-badge');
                if (bottomBadge) {
                    if (totalUnread > 0) {
                        bottomBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                        bottomBadge.style.display = 'flex';
                        // Re-trigger anima√ß√£o
                        bottomBadge.style.animation = 'none';
                        bottomBadge.offsetHeight;
                        bottomBadge.style.animation = 'badge-attention 1.5s ease forwards, pulse-soft 2s infinite 1.5s';
                    } else {
                        bottomBadge.style.display = 'none';
                    }
                }

                // Iniciar monitoramento de dist√¢ncia se houver coordenadas
                children.forEach(child => {
                    if (child.school_latitude && child.school_longitude) {
                        startDistanceTracking(child);
                    }
                });

            } catch (error) {
                console.error('Erro:', error);
            }
        }

        const distanceTrackers = {};

        function startDistanceTracking(child) {
            if (distanceTrackers[child.id]) clearInterval(distanceTrackers[child.id]);

            const track = () => {
                if (!navigator.geolocation) return;

                navigator.geolocation.getCurrentPosition(position => {
                    console.log(`[GEO] Aluno ${child.id}: Escola em [${child.school_latitude}, ${child.school_longitude}], Voc√™ em [${position.coords.latitude}, ${position.coords.longitude}]`);

                    const dist = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        child.school_latitude,
                        child.school_longitude
                    );

                    const infoDiv = document.getElementById(`dist-info-${child.id}`);
                    const btn = document.getElementById(`pickup-btn-${child.id}`);
                    const remoteBtn = document.getElementById(`remote-btn-${child.id}`);

                    // Debug t√©cnico opcional (invis√≠vel mas √∫til no log)
                    if (infoDiv) infoDiv.setAttribute('data-geo', `${child.school_latitude},${child.school_longitude}`);

                    // Calcular dist√¢ncia em metros
                    const distMeters = dist * 1000;

                    if (infoDiv) {
                        const distText = dist < 1 ? `${distMeters.toFixed(0)}m` : `${dist.toFixed(1)}km`;
                        const statusColor = distMeters <= 30 ? '#10b981' : (distMeters <= 200 ? '#f59e0b' : '#ef4444');
                        infoDiv.innerHTML = `<span style="color: ${statusColor};">üìç Voc√™ est√° a <b>${distText}</b> da escola</span>`;
                    }

                    if (btn) {
                        // REGRA: S√≥ ativa o bot√£o se estiver a <= 30 metros
                        if (distMeters <= 30) {
                            // PR√ìXIMO - Ativar bot√£o
                            btn.disabled = false;
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                            btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                            btn.style.boxShadow = '0 4px 20px rgba(16, 185, 129, 0.4)';
                            btn.innerHTML = '‚úÖ Estou na Escola - Notificar Chegada!';
                            btn.classList.add('pulse-animation');

                            // Esconder bot√£o de autoriza√ß√£o remota quando pr√≥ximo
                            if (remoteBtn) remoteBtn.style.display = 'none';

                        } else if (distMeters <= 200) {
                            // CHEGANDO (at√© 200m) - Ainda n√£o pode clicar, mas est√° perto
                            btn.disabled = true;
                            btn.style.opacity = '0.8';
                            btn.style.cursor = 'not-allowed';
                            btn.style.background = '#f59e0b';
                            btn.style.boxShadow = 'none';
                            btn.innerHTML = `üö∂ Aproxime-se mais (${distMeters.toFixed(0)}m)`;
                            btn.classList.remove('pulse-animation');

                            // Mostrar bot√£o de autoriza√ß√£o remota
                            if (remoteBtn) remoteBtn.style.display = 'flex';

                        } else {
                            // LONGE - Desativado, mostrar op√ß√£o de autoriza√ß√£o remota
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.style.cursor = 'not-allowed';
                            btn.style.background = '#94a3b8';
                            btn.style.boxShadow = 'none';
                            btn.style.transform = 'scale(1)';
                            btn.innerHTML = 'üöó V√° at√© a escola para notificar';
                            btn.classList.remove('pulse-animation');

                            // Mostrar bot√£o de autoriza√ß√£o remota
                            if (remoteBtn) remoteBtn.style.display = 'flex';
                        }
                    }
                }, err => {
                    console.error('Erro de geo:', err);
                    // Se n√£o conseguir localiza√ß√£o, mostrar bot√£o de autoriza√ß√£o remota
                    const remoteBtn = document.getElementById(`remote-btn-${child.id}`);
                    if (remoteBtn) remoteBtn.style.display = 'flex';
                }, { enableHighAccuracy: true, timeout: 10000 });
            };

            track();
            distanceTrackers[child.id] = setInterval(track, 5000); // Atualiza a cada 5 segundos
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function requestPickup(studentId, schoolId) {
            const btn = document.getElementById(`pickup-btn-${studentId}`);
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Enviando...';

                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/pickup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ student_id: studentId, school_id: schoolId })
                });

                const data = await res.json();
                if (data.success) {
                    // Mudar para estado de "aguardando chamada"
                    btn.style.background = 'linear-gradient(135deg, #6366f1, #4f46e5)';
                    btn.style.boxShadow = '0 4px 20px rgba(99, 102, 241, 0.4)';
                    btn.innerHTML = '‚úÖ Portaria Notificada - Aguardando Chamada';
                    btn.classList.add('waiting-call-animation');

                    // Guardar estado para n√£o perder ao recarregar
                    localStorage.setItem(`pickup_waiting_${studentId}`, 'true');
                } else {
                    alert(data.message || 'Erro ao notificar');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                alert('Erro ao notificar');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Fun√ß√£o para autoriza√ß√£o remota (quando respons√°vel est√° longe e outra pessoa vai buscar)
        async function requestRemotePickup(studentId, schoolId, studentName) {
            // Mostrar modal de confirma√ß√£o
            const confirmed = confirm(
                `‚ö†Ô∏è ATEN√á√ÉO: AUTORIZA√á√ÉO REMOTA\n\n` +
                `Voc√™ est√° longe da escola e est√° autorizando a retirada de:\n\n` +
                `üë§ ${studentName}\n\n` +
                `Isso significa que OUTRA PESSOA ir√° buscar seu filho(a) na escola.\n\n` +
                `A escola ser√° notificada de que voc√™ autorizou a retirada remotamente.\n\n` +
                `Deseja realmente autorizar?`
            );

            if (!confirmed) {
                return; // Usu√°rio cancelou
            }

            const btn = document.getElementById(`remote-btn-${studentId}`);
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Enviando autoriza√ß√£o...';

                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/pickup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        school_id: schoolId,
                        remote_authorization: true // Flag indicando que foi autoriza√ß√£o remota
                    })
                });

                const data = await res.json();
                if (data.success) {
                    btn.style.background = 'rgba(16, 185, 129, 0.2)';
                    btn.style.color = '#10b981';
                    btn.style.border = '1px solid #10b981';
                    btn.innerHTML = '‚úÖ Autoriza√ß√£o enviada!';

                    // Mostrar alerta de sucesso
                    alert(`‚úÖ Autoriza√ß√£o remota enviada!\n\nA escola foi notificada que voc√™ autorizou a retirada de ${studentName}.\n\nLembre-se: Somente pessoas autorizadas poder√£o retirar.`);

                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.background = 'rgba(239, 68, 68, 0.1)';
                        btn.style.color = '#ef4444';
                        btn.style.border = '1px solid rgba(239, 68, 68, 0.2)';
                    }, 10000);
                } else {
                    alert(data.message || 'Erro ao enviar autoriza√ß√£o');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                alert('Erro na conex√£o. Tente novamente.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- RELAT√ìRIOS ---


        // --- EVENTOS E NOTIFICA√á√ïES DA ESCOLA ---
        // --- EVENTOS E NOTIFICA√á√ïES DA ESCOLA (REESCRITO PARA ROBUSTEZ V2) ---
        async function loadEventsAndNotifications(silent = false) {
            const eventsListDiv = document.getElementById('eventsList');
            const eventsEmptyDiv = document.getElementById('eventsEmpty');

            if (!eventsListDiv) {
                console.error("‚ùå Elemento eventsList n√£o encontrado no DOM!");
                return;
            }

            console.log("üöÄ Iniciando carga de eventos... Silent:", silent);

            // Estado de carregamento apenas se n√£o for silencioso
            if (!silent) {
                eventsListDiv.innerHTML = `
                <div id="event-loading-state" style="text-align:center; padding:40px 20px; color:#6b7280;">
                    <div style="display:inline-block; width:28px; height:28px; border:3px solid #f3f4f6; border-top-color:#6366f1; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:12px;"></div>
                    <p style="font-size:14px; font-weight:500;">Buscando avisos da escola...</p>
                </div>`;
            }
            if (eventsEmptyDiv) eventsEmptyDiv.classList.add('hidden');

            // Timeout de seguran√ßa: se em 8 segundos n√£o carregar, mostra erro
            const timeoutId = setTimeout(() => {
                const loader = document.getElementById('event-loading-state');
                if (loader) {
                    console.warn("‚ö†Ô∏è O carregamento de eventos demorou demais...");
                    eventsListDiv.innerHTML = `
                        <div style="text-align:center; padding:30px; background:#fff1f2; border-radius:12px; border:1px solid #fecaca; color:#b91c1c;">
                            <p style="font-weight:600;">O servidor demorou a responder.</p>
                            <button onclick="loadEventsAndNotifications()" style="margin-top:12px; padding:10px 20px; background:#ef4444; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Tentar Novamente</button>
                        </div>
                    `;
                }
            }, 8000);

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error("‚ùå Token ausente no localStorage");
                    clearTimeout(timeoutId);
                    showLogin();
                    return;
                }

                console.log("üì° Chamando API de eventos...");
                const response = await fetch(`${API_URL}/guardian/school-events`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Servidor respondeu com status ${response.status}`);
                }

                const data = await response.json();

                // Tratar resposta: Array plano ou Objeto { events: [...] }
                let events = [];
                if (Array.isArray(data)) {
                    events = data;
                } else if (data.events && Array.isArray(data.events)) {
                    events = data.events;
                }

                console.log(`‚úÖ ${events.length} eventos recebidos.`);

                if (events.length === 0) {
                    eventsListDiv.innerHTML = '';
                    eventsEmptyDiv.classList.remove('hidden');
                    return;
                }

                // Renderiza√ß√£o pura e direta
                let html = '';
                events.forEach(event => {
                    const eventDate = event.event_date ? new Date(event.event_date + 'T12:00:00') : null;
                    const dateDisplay = eventDate ? eventDate.toLocaleDateString('pt-BR') : 'Data pendente';
                    const valor = event.cost ? parseFloat(event.cost) : 0;

                    let typeBadge = '';
                    if (event.type === 'trip') typeBadge = '<span style="background:#8b5cf6; color:white; font-size:11px; padding:3px 8px; border-radius:12px; font-weight:700; text-transform:uppercase; margin-right:8px;">üöå Passeio</span>';
                    else if (event.type === 'warning') typeBadge = '<span style="background:#f59e0b; color:white; font-size:11px; padding:3px 8px; border-radius:12px; font-weight:700; text-transform:uppercase; margin-right:8px;">‚ö†Ô∏è Aviso</span>';
                    else typeBadge = '<span style="background:#3b82f6; color:white; font-size:11px; padding:3px 8px; border-radius:12px; font-weight:700; text-transform:uppercase; margin-right:8px;">üìÖ Evento</span>';

                    html += `
                        <div class="event-card" style="background:white; border-radius:16px; padding:20px; margin-bottom:16px; border:1px solid #f3f4f6; box-shadow:0 10px 15px -3px rgba(0,0,0,0.05);">
                            <div style="margin-bottom:8px;">${typeBadge}</div>
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                                <h3 style="font-size:18px; font-weight:700; color:#111827; margin:0;">${event.title || 'Comunicado'}</h3>
                                ${valor > 0 ? `<span style="background:#ecfdf5; color:#065f46; font-size:12px; font-weight:700; padding:4px 10px; border-radius:20px;">R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>` : ''}
                            </div>
                            <p style="font-size:14px; color:#4b5563; line-height:1.5; margin:0 0 16px 0;">${event.description || ''}</p>
                            
                            <div style="display:flex; flex-wrap:wrap; gap:12px; font-size:12px; color:#6b7280; font-weight:500;">
                                <div style="display:flex; align-items:center; gap:5px;">üìÖ ${dateDisplay}</div>
                                <div style="display:flex; align-items:center; gap:5px;">üè´ ${event.school_name || 'Escola'}</div>
                                <div style="display:flex; align-items:center; gap:5px;">üìö ${event.class_name || 'Geral'}</div>
                                <div style="display:flex; align-items:center; gap:5px; color: #6366f1; font-weight: 700;">üë• ${event.confirmation_count || 0} confirmados</div>
                            </div>

                            ${event.pix_key ? `
                                <div style="margin-top:20px; padding:15px; background:#f9fafb; border-radius:12px; border:1px dashed #d1d5db;">
                                    <p style="font-size:12px; font-weight:700; color:#374151; margin:0 0 8px 0; text-transform:uppercase; letter-spacing:0.5px;">Chave PIX para pagamento:</p>
                                    <div style="font-family:monospace; background:white; padding:8px; border-radius:6px; border:1px solid #e5e7eb; font-size:13px; color:#111827; word-break:break-all;">${event.pix_key}</div>
                                    ${event.payment_deadline ? `<p style="font-size:11px; color:#ef4444; margin:8px 0 0 0; font-weight:600;">‚ö†Ô∏è Pagar at√©: ${new Date(event.payment_deadline + 'T12:00:00').toLocaleDateString('pt-BR')}</p>` : ''}
                                </div>
                                <div style="display:flex; gap:10px; margin-top:12px;">
                                    <button onclick="confirmEventParticipation(${event.id}, ${event.schoolId || event.school_id})" 
                                            style="flex:1; background:#6366f1; color:white; border:none; padding:12px; border-radius:12px; font-weight:700; font-size:13px; cursor:pointer;">
                                        ‚úÖ Confirmar
                                    </button>
                                    <input type="file" id="receipt-${event.id}" accept="image/*,application/pdf" style="display:none" onchange="uploadReceipt(this, ${event.id}, ${event.schoolId || event.school_id})">
                                    <button onclick="document.getElementById('receipt-${event.id}').click()" 
                                            style="flex:1; background:#10b981; color:white; border:none; padding:12px; border-radius:12px; font-weight:700; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:5px;">
                                        üì§ Comprovante
                                    </button>
                                </div>
                            ` : `
                                <button onclick="confirmEventParticipation(${event.id}, ${event.schoolId || event.school_id})" 
                                        style="width:100%; margin-top:20px; background:#6366f1; color:white; border:none; padding:14px; border-radius:12px; font-weight:700; font-size:14px; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 6px -1px rgba(99, 102, 241, 0.2);">
                                    ‚úÖ Estar Ciente / Participar
                                </button>
                            `}
                        </div>
                    `;
                });

                eventsListDiv.innerHTML = html;

            } catch (err) {
                clearTimeout(timeoutId);
                console.error("‚ùå Erro fatal ao carregar eventos:", err);
                eventsListDiv.innerHTML = `
                    <div style="text-align:center; padding:30px; background:#fff; border-radius:16px; border:1px solid #e5e7eb; color:#4b5563;">
                        <p style="font-weight:600; color:#ef4444;">Falha na conex√£o com a escola</p>
                        <p style="font-size:13px; margin-top:5px;">Verifique sua internet ou tente novamente mais tarde.</p>
                        <button onclick="loadEventsAndNotifications()" style="margin-top:15px; padding:12px 24px; background:#6366f1; color:white; border:none; border-radius:12px; font-weight:600; cursor:pointer;">Tentar Novamente</button>
                    </div>
                `;
            }
        }

        async function uploadReceipt(input, eventId, schoolId) {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('receipt', file);

            if (!confirm('Deseja enviar este arquivo como comprovante?')) return;

            try {
                const token = localStorage.getItem('token');
                // Reutiliza a rota de confirm, que agora aceita multipart
                const res = await fetch(`${API_URL}/guardian/school-events/${schoolId}/${eventId}/confirm`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (res.ok) {
                    alert('Comprovante enviado com sucesso!');
                    loadEventsAndNotifications();
                } else {
                    alert('Erro ao enviar comprovante.');
                }
            } catch (e) {
                alert('Erro de conex√£o ao enviar.');
                console.error(e);
            }
        }

        async function confirmEventParticipation(eventId, schoolId) {
            if (!confirm('Deseja confirmar a participa√ß√£o/leitura deste evento?')) return;

            try {
                const token = localStorage.getItem('token');
                // Rota com schoolId para evitar ambiguidade
                const res = await fetch(`${API_URL}/guardian/school-events/${schoolId}/${eventId}/confirm`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    alert('Confirma√ß√£o registrada com sucesso!');
                    loadEventsAndNotifications();
                } else {
                    alert('Erro ao registrar confirma√ß√£o.');
                }
            } catch (e) {
                alert('Erro de conex√£o ao confirmar.');
            }
        }

        // --- CHAT SYSTEM ---
        function loadChatList() {
            const list = document.getElementById('chatList');
            const empty = document.getElementById('emptyChat');

            if (!myStudentsData || myStudentsData.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            list.innerHTML = myStudentsData.map(s => `
                <div class="child-card-prof" onclick="openChat(${s.id})" style="flex-direction: row; align-items: center; cursor: pointer; padding: 16px;">
                    <div class="child-avatar-prof" style="width: 50px !important; height: 50px !important; min-width: 50px !important; font-size: 20px;">
                        ${s.photo_url ? `<img src="${s.photo_url}" alt="${s.name}" style="width: 100% !important; height: 100% !important; object-fit: cover;">` : s.name.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div class="child-name-prof" style="font-size: 16px; margin-bottom: 2px;">${s.name}</div>
                        <div class="child-details-prof">${s.school_name || 'Escola'}</div>
                    </div>
                    <div style="font-size: 20px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
            `).join('');
        }

        async function openChat(studentId) {
            activeChatStudentId = studentId;
            const student = myStudentsData.find(s => s.id == studentId);
            if (!student) return;

            // UI Setup
            document.getElementById('messagesScreen').classList.add('hidden');
            document.getElementById('bottomNav').classList.add('hidden');
            document.getElementById('chatScreen').classList.remove('hidden');
            document.getElementById('chatStudentName').textContent = student.name;
            document.getElementById('chatSchoolName').textContent = student.schoolName || 'Escola';

            // Logic
            fetchMessages();
            if (chatPollInterval) clearInterval(chatPollInterval);
            chatPollInterval = setInterval(fetchMessages, 3000); // Poll every 3s

            // Input logic toggle
            const input = document.getElementById('messageInput');
            input.oninput = () => {
                const send = document.getElementById('sendBtn');
                if (input.value.trim().length > 0) {
                    send.style.display = 'block';
                } else {
                    send.style.display = 'none';
                }
            };
        }

        function closeChat() {
            activeChatStudentId = null;
            if (chatPollInterval) clearInterval(chatPollInterval);

            document.getElementById('chatScreen').classList.add('hidden');
            document.getElementById('messagesScreen').classList.remove('hidden');
            document.getElementById('bottomNav').classList.remove('hidden');
        }

        async function fetchMessages() {
            if (!activeChatStudentId) return;
            const student = myStudentsData.find(s => s.id == activeChatStudentId);
            if (!student) return;

            try {
                const token = localStorage.getItem('token');
                const schoolId = student.schoolId || student.school_id;
                const res = await fetch(`${API_URL}/guardian/chat/${activeChatStudentId}/messages?schoolId=${schoolId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    console.error('‚ùå Erro ao buscar mensagens:', res.status);
                    return;
                }

                const data = await res.json();
                console.log('üì® Mensagens recebidas:', data);

                // Garantir que data √© um array
                const msgs = Array.isArray(data) ? data : [];
                renderMessages(msgs);
            } catch (e) {
                console.error('‚ùå Erro fetchMessages:', e);
                renderMessages([]);
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('chatMessages');
            if (!container) return;

            // Validar que messages √© um array
            if (!Array.isArray(messages)) {
                console.error('‚ùå renderMessages recebeu dados inv√°lidos:', messages);
                messages = [];
            }

            // Check if user is near bottom to auto-scroll
            const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;

            const serverOrigin = API_URL.replace('/api', '');
            let lastRenderedDate = null; // Track date changes

            // Map messages
            const html = messages.map((msg, index) => {
                const isMe = msg.sender_type === 'guardian';
                let contentHtml = msg.content || '';

                if (msg.type === 'image') {
                    contentHtml = `<img src="${serverOrigin}${msg.file_url}" class="chat-img-preview" onclick="window.open(this.src)">`;
                } else if (msg.type === 'audio') {
                    contentHtml = `<audio controls src="${serverOrigin}${msg.file_url}" class="chat-audio"></audio>`;
                } else if (msg.type === 'file') {
                    contentHtml = `<a href="${serverOrigin}${msg.file_url}" target="_blank">üìé ${msg.file_name || 'Arquivo'}</a>`;
                }

                // Data Handling
                const rawDate = msg.created_at || '';
                const currentDate = rawDate ? new Date(rawDate.replace(' ', 'T')) : new Date();
                const currentDateStr = currentDate.toDateString();

                let dateDividerHtml = '';
                // Only show divider if date string changed since last message
                if (lastRenderedDate !== currentDateStr) {
                    let label = currentDate.toLocaleDateString('pt-BR');
                    if (currentDateStr === new Date().toDateString()) label = 'Hoje';
                    dateDividerHtml = `<div class="date-divider">${label}</div>`;
                    lastRenderedDate = currentDateStr;
                }

                const time = currentDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }).replace('Invalid Date', '--:--');

                return `
                    ${dateDividerHtml}
                    <div class="chat-bubble ${isMe ? 'sent' : 'received'}">
                        ${contentHtml}
                        <div class="chat-time">${time}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;

            if (isNearBottom || messages.length > 0) { // Simple scroll logic
                container.scrollTop = container.scrollHeight;
            }
        }

        async function sendMessage(file = null, type = 'text') {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content && !file) return;

            const student = myStudentsData.find(s => s.id == activeChatStudentId);
            if (!student) {
                console.error('‚ùå Aluno n√£o encontrado!', activeChatStudentId);
                alert('Erro: Aluno n√£o encontrado');
                return;
            }

            console.log('üì§ Enviando mensagem para aluno:', student.name);
            console.log('üè´ School ID:', student.schoolId || student.school_id);

            const token = localStorage.getItem('token');

            const formData = new FormData();
            formData.append('schoolId', student.schoolId || student.school_id);
            if (content) formData.append('content', content);
            if (file) formData.append('file', file);
            formData.append('type', type);

            try {
                // Optimistic UI update could be here
                input.value = '';
                document.getElementById('sendBtn').style.display = 'none';

                const url = `${API_URL}/guardian/chat/${activeChatStudentId}/messages`;
                console.log('üåê URL:', url);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                console.log('üì• Resposta:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Erro do servidor:', errorText);
                    throw new Error(`Servidor retornou ${response.status}`);
                }

                fetchMessages();
            } catch (e) {
                console.error('‚ùå Erro ao enviar:', e);
                alert('Erro ao enviar: ' + e.message);
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Determine type
            let type = 'file';
            if (file.type.startsWith('image/')) type = 'image';
            if (file.type.startsWith('audio/')) type = 'audio';

            if (confirm(`Enviar ${file.name}?`)) {
                sendMessage(file, type);
            }
            input.value = ''; // Reset
        }

        // --- AUDIO RECORDING ---
        function startRecording() {
            if (!navigator.mediaDevices) {
                alert('Audio n√£o suportado neste navegador/contexto');
                return;
            }
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];

                    document.getElementById('micBtn').style.color = 'red';

                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); // Chrome uses webm
                        const file = new File([audioBlob], `audio_${Date.now()}.webm`, { type: 'audio/webm' });
                        sendMessage(file, 'audio');
                        document.getElementById('micBtn').style.color = '#54656f';
                    });
                });
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        async function participate(evtId, schoolId, action) {
            // Confirma√ß√£o simples
            const labels = {
                'interested': 'informar interesse neste evento',
                'inform_payment': 'confirmar que j√° realizou o pagamento',
                'confirm_presence': 'confirmar presen√ßa'
            };
            const label = labels[action] || 'participar';
            if (!confirm(`Deseja ${label}? A escola ser√° notificada.`)) return;

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/guardian/events/${evtId}/participate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ schoolId, action })
                });

                if (res.ok) {
                    alert('Confirma√ß√£o enviada com sucesso!');
                } else {
                    const err = await res.json();
                    alert('Erro: ' + (err.error || 'Falha ao enviar'));
                }
            } catch (e) {
                console.error('Erro:', e);
                alert('Erro de conex√£o');
            }
        }

        // ===== SERVER-SENT EVENTS (SSE) PARA EVENTOS EM TEMPO REAL =====
        let eventsSSE = null;

        function startEventsSSE() {
            // Parar conex√£o anterior se existir
            stopEventsSSE();

            const token = localStorage.getItem('token');
            if (!token) {
                console.error('‚ùå Token n√£o encontrado para SSE');
                return;
            }

            console.log('üîå Conectando SSE para eventos em tempo real...');

            // Criar conex√£o SSE
            eventsSSE = new EventSource(`${API_URL}/guardian/events-stream?token=${token}`);

            eventsSSE.onopen = () => {
                console.log('‚úÖ SSE conectado! Escutando eventos da escola...');
            };

            eventsSSE.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'connected') {
                        console.log('üîó SSE: Conex√£o estabelecida');
                    } else if (data.type === 'events') {
                        console.log(`üì® SSE: ${data.data.length} eventos recebidos`);
                        renderEventsFromSSE(data.data);
                    } else if (data.type === 'notification') {
                        const notif = data.data;
                        let msg = "Nova notifica√ß√£o";
                        /*
                        if (notif.event_type && (notif.event_type.includes('pickup') || notif.event_type.includes('released'))) {
                            msg = `O aluno ${notif.student_name || ''} est√° vindo!`;
                        } else {
                            msg = `Notifica√ß√£o: ${notif.event_type}`;
                        }
                        showSystemNotification(msg);
                        */
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao processar SSE:', e);
                }
            };

            eventsSSE.onerror = (error) => {
                console.error('‚ùå Erro na conex√£o SSE:', error);
                // Tentar reconectar ap√≥s 5 segundos
                setTimeout(() => {
                    console.log('üîÑ Tentando reconectar SSE...');
                    startEventsSSE();
                }, 5000);
            };
        }

        function stopEventsSSE() {
            if (eventsSSE) {
                console.log('üîå Fechando conex√£o SSE de eventos...');
                eventsSSE.close();
                eventsSSE = null;
            }
        }

        /*
        function showSystemNotification(msg) {
            if ("Notification" in window) {
                if (Notification.permission === "granted") {
                    new Notification("EduFocus", { body: msg });
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            }
        }
        */

        function renderEventsFromSSE(events) {
            const eventsListDiv = document.getElementById('eventsList');
            const eventsEmptyDiv = document.getElementById('eventsEmpty');

            if (!eventsListDiv) return;

            if (events.length === 0) {
                eventsListDiv.innerHTML = '';
                if (eventsEmptyDiv) eventsEmptyDiv.classList.remove('hidden');
                return;
            }

            if (eventsEmptyDiv) eventsEmptyDiv.classList.add('hidden');

            let html = '';
            events.forEach(event => {
                const eventDate = event.event_date ? new Date(event.event_date + 'T12:00:00') : null;
                const dateDisplay = eventDate ? eventDate.toLocaleDateString('pt-BR') : 'Data pendente';
                const valor = event.cost ? parseFloat(event.cost) : 0;

                let typeBadge = '';
                if (event.type === 'trip') typeBadge = '<span style="background:#8b5cf6; color:white; font-size:11px; padding:3px 8px; border-radius:12px; font-weight:700; text-transform:uppercase; margin-right:8px;">üöå Passeio</span>';
                else if (event.type === 'warning') typeBadge = '<span style="background:#f59e0b; color:white; font-size:11px; padding:3px 8px; border-radius:12px; font-weight:700; text-transform:uppercase; margin-right:8px;">‚ö†Ô∏è Aviso</span>';
                else typeBadge = '<span style="background:#3b82f6; color:white; font-size:11px; padding:3px 8px; border-radius:12px; font-weight:700; text-transform:uppercase; margin-right:8px;">üìÖ Evento</span>';

                html += `
                    <div class="event-card" style="background:white; border-radius:16px; padding:20px; margin-bottom:16px; border:1px solid #f3f4f6; box-shadow:0 10px 15px -3px rgba(0,0,0,0.05);">
                        <div style="margin-bottom:8px;">${typeBadge}</div>
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                            <h3 style="font-size:18px; font-weight:700; color:#111827; margin:0;">${event.title || 'Comunicado'}</h3>
                            ${valor > 0 ? `<span style="background:#ecfdf5; color:#065f46; font-size:12px; font-weight:700; padding:4px 10px; border-radius:20px;">R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>` : ''}
                        </div>
                        <p style="font-size:14px; color:#4b5563; line-height:1.5; margin:0 0 16px 0;">${event.description || ''}</p>
                        
                        <div style="display:flex; flex-wrap:wrap; gap:12px; font-size:12px; color:#6b7280; font-weight:500;">
                            <div style="display:flex; align-items:center; gap:5px;">üìÖ ${dateDisplay}</div>
                            <div style="display:flex; align-items:center; gap:5px;">üè´ ${event.school_name || 'Escola'}</div>
                            <div style="display:flex; align-items:center; gap:5px;">üìö ${event.class_name || 'Geral'}</div>
                        </div>
                    </div>
                `;
            });

            eventsListDiv.innerHTML = html;
        }

        // Parar SSE ao sair da p√°gina
        window.addEventListener('beforeunload', () => {
            stopEventsSSE();
        });

        document.body.addEventListener('click', () => {
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
        }, { once: true });

        // Polling para mensagens n√£o lidas
        let unreadPoller = null;
        function startUnreadPoller() {
            if (unreadPoller) clearInterval(unreadPoller);
            unreadPoller = setInterval(() => {
                if (localStorage.getItem('token')) {
                    loadChildren(true); // silent
                }
            }, 10000); // 10 segundos
        }

        // Iniciar Pollers
        startUnreadPoller();
        setTimeout(startEventsSSE, 1000);


    </script>
</body>

</html>